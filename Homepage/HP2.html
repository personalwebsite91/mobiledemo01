<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <title>SHAKTI-IND ‚Äî Mobile</title>
  <style>
    :root{
      --bg:#ffffff;
      --saffron:#FF9933;
      --green:#138808;
      --card:#fff;
      --muted:#777;
      --popup-comments-height: 0vh; /* toggled by JS (0 or 36vh) */
      --avatar-bg: #f3f4f6; /* neutral avatar background */
      --avatar-fg: #1f2937; /* avatar text color */
    }
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);-webkit-text-size-adjust:none;color:#111;}
    .app { min-height:100vh; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; }

    /* hide scrollbars visually (but keep scrolling) */
    * { scrollbar-width: none; -ms-overflow-style: none; }
    *::-webkit-scrollbar { display: none; }

    /* header */
    .top-left-header{
      position:fixed;
      left: env(safe-area-inset-left, 12px);
      top: calc(env(safe-area-inset-top, 12px));
      right: 0px;
      z-index:1400;
      display:flex;
      align-items:center;
      gap:80px;
      background: rgba(255,255,255,0.98);
      padding:10px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      box-sizing:border-box;
      max-width: calc(100%-8px);
      transition: transform 160ms ease, padding 160ms ease;
    }
    .brand { font-weight:900; font-size:18px; letter-spacing:1px;
      background:linear-gradient(90deg,var(--saffron) 50%, var(--green) 50%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
       white-space:nowrap;
    }
    .small-username{ font-size:12px; color:#111; font-weight:700; margin-top:2px; }
    .top-search { flex:1; display:flex; align-items:center; gap:8px; background:#f6f6f6; padding:8px; border-radius:10px; }
    .top-search input{ border:none; outline:none; background:transparent; font-size:13px; width:100%; min-width:0; }

    /* story strip */
    .story-strip-wrapper { width:100%; max-width:720px; margin-top: calc( (env(safe-area-inset-top, 12px) + 6px) + 64px - 10px ); box-sizing:border-box; padding:6px 12px 0; }
    .story-strip { display:flex; gap:10px; padding:10px 4px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .story-item { min-width:72px; flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px; border-radius:999px; background:#fff; box-shadow:0 6px 12px rgba(0,0,0,0.04); text-align:center; font-size:12px; cursor:pointer; white-space:nowrap; border:1px solid rgba(0,0,0,0.03); }
    .story-item.active { outline: 2px solid rgba(19,136,8,0.12); box-shadow:0 8px 18px rgba(19,136,8,0.06); font-weight:700; }

    /* feed main */
    .main-feed-container{ width:100%; max-width:720px; padding: 8px 12px 120px; box-sizing:border-box; margin-top:6px; }
    .feed-card{ background:var(--card); border-radius:14px; padding:12px; box-shadow:0 6px 24px rgba(0,0,0,0.06); margin-bottom:18px; overflow:visible; }
    .feed-row{ display:flex; gap:14px; align-items:flex-start; box-sizing:border-box; flex-direction:row; }
    .post-box{ width:55%; background:#fafafa; border-radius:12px; padding:10px; box-sizing:border-box; box-shadow:0 3px 10px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:8px; }
    .comment-box{ width:45%; background:var(--card); border-radius:12px; padding:8px; box-sizing:border-box; border:1px solid #f0f0f0; max-height:320px; overflow:auto; }

    .post-header{ display:flex; gap:8px; align-items:center; }
    /* replaced colorful gradient with neutral avatar style */
    .post-user-pic{ width:36px; height:36px; border-radius:50%; background:var(--avatar-bg); color:var(--avatar-fg); flex:0 0 36px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; }
    .post-username{ font-weight:600; font-size:13px; color:#222; margin:0; }
    .post-time{ font-size:11px; color:var(--muted); margin-top:2px; }
    .post-img, .post-video { width:100%; border-radius:10px; display:block; object-fit:cover; cursor:pointer; max-height:420px; }

    .post-actions{ display:flex; gap:8px; align-items:center; justify-content:flex-start; font-size:13px; color:var(--muted); }
    .action-btn{ background:none; border:none; font-weight:600; cursor:pointer; padding:6px; border-radius:8px }
    .post-hashtag{ color:var(--green); font-weight:700; font-size:12px; margin-top:6px; }

    .comment{ display:flex; gap:8px; align-items:flex-start; margin-bottom:10px; justify-content:flex-start; }
    .comment-left{ display:flex; gap:8px; align-items:flex-start; flex:1; min-width:0; }
    /* comment avatars neutral as well */
    .comment-user-pic{ width:18px; height:18px; border-radius:50%; flex:0 0 18px; margin-top:2px; background:var(--avatar-bg); color:var(--avatar-fg); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; }
    .comment-body{ min-width:0; flex:1; }
    .comment-header-line{ display:flex; align-items:center; justify-content:space-between; gap:4px; }
    .comment-username{ font-weight:600; font-size:12px; color:#222; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .comment-text{ font-size:12px; color:#444; display:block; margin-top:2px; white-space:normal; }
    .comment-meta{ font-size:10px; color:var(--muted); margin-top:4px; }
    .heart-small{ background:transparent; border:none; font-size:13px; cursor:pointer; padding:0 4px; color:#d33; }

    /* bottom navbar */
    .bottom-nav{ position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom,0); height:62px; background:var(--card); display:flex; align-items:center; justify-content:center; box-shadow:0 -10px 30px rgba(0,0,0,0.06); z-index:1100; padding-bottom: calc(env(safe-area-inset-bottom, 0px)); }
    .nav-inner{ max-width:720px; width:100%; display:flex; justify-content:space-around; align-items:center; padding:6px 12px; box-sizing:border-box; }
    .nav-item{ font-size:14px; color:#666; text-align:center; flex:1; cursor:pointer; }
    .nav-item .icon{ display:block; font-size:18px; margin-bottom:2px }
    .nav-item.active{ color:var(--green); font-weight:700; }

    /* skeleton shimmer */
    .skeleton { background: linear-gradient(90deg,#f2f2f2 0%, #ececec 50%, #f6f6f6 100%); background-size: 200% 100%; animation: skeleton-shimmer 1.2s linear infinite; border-radius: 10px; }
    @keyframes skeleton-shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }

    /* ------------------- POPUP (FULLSCREEN) ------------------- */
    .post-popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: stretch;
      justify-content: center;
      z-index: 3000;
      background: rgba(0,0,0,0.95);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      padding: 0;
      box-sizing: border-box;
    }

    .popup-inner {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: transparent;
      border-radius: 0;
      overflow: hidden;
      position: relative;
    }

    /* media area covers the whole screen (behind comments) */
    .popup-media-wrap {
      position: relative;
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden;
      background: #000;
    }

    .popup-bg {
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center center;
      filter: blur(22px) saturate(120%);
      transform: scale(1.08);
      opacity:0.98;
      z-index:10;
      transition: opacity 220ms ease;
    }

    .popup-media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: calc(100% - var(--popup-comments-height)); /* shrink when comments open */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      z-index:20;
      transition: height 260ms cubic-bezier(.2,.9,.2,1), padding 220ms ease, transform 220ms ease;
      padding-top: 0;
    }

    /* When comments are open we want media to be top-aligned & smaller */
    .popup-media.comments-open {
      align-items:flex-start;
      justify-content:center;
      padding-top:22px;
      /* add a tiny translateY so it looks like it moves up when comments open */
      transform: translateY(-6px);
    }

    /* VIDEO/IMG styling inside popup holder */
    .popup-media video,
    .popup-media img {
      max-width:94%;
      max-height: calc(100% - 40px);
      display:block;
      z-index:22;
      background:#000;
      border-radius:12px;
      transition: width 220ms ease, height 220ms ease, object-fit 160ms ease, transform 180ms ease;
      object-fit: cover;
    }

    /* If comments open, reduce media size slightly */
    .popup-media.comments-open video,
    .popup-media.comments-open img {
      max-width: 86%;
      max-height: calc(100% - 8px); /* leave small gap above comment area */
      border-radius:10px;
    }

    /* top controls: close / play / arrows */
    .popup-top-controls{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      gap:8px;
      z-index:60;
      align-items:center;
    }
    .popup-top-controls button{ background: rgba(255,255,255,0.08); border:none; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }

    /* comment toggle handle (hidden until tapped) */
    .popup-comments {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 0;               /* start hidden */
      max-height: 60vh;
      overflow: auto;
      background: linear-gradient(0deg, rgba(20,20,20,0.98), rgba(20,20,20,0.9));
      color: #f7f7f7;
      transition: height 260ms cubic-bezier(.2,.9,.2,1), padding 180ms ease;
      z-index:70;
      box-sizing:border-box;
      padding: 0 12px;
    }
    .popup-comments.open { height: 36vh; padding: 12px; } /* visible state */

    /* bottom comment handle visible above the fold */
    .comment-handle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(36vh - 12px); /* when open it sits above comment box; but hidden by default */
      width: 56px;
      height: 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.12);
      z-index: 80;
      display: none;
    }
    .popup-comments.open + .comment-handle { display:block; }

    .popup-comment { display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
    .popup-comment .avatar { width:28px; height:28px; border-radius:50%; flex:0 0 28px; background:var(--avatar-bg); color:var(--avatar-fg); display:flex; align-items:center; justify-content:center; font-weight:700; }
    .popup-comment .body { flex:1; max-width: calc(100% - 40px); }
    .popup-comment .meta { font-size:12px; color: #ddd; margin-top:6px; display:flex; align-items:center; gap:8px; }
    .popup-comment .like { background:transparent; border:none; color:#ff6b6b; font-size:16px; cursor:pointer; }

    .popup-reply { display:flex; gap:8px; margin-top:8px; align-items:center; position:sticky; bottom:6px; background:transparent; padding-bottom:8px; }
    .popup-reply input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2); color:#fff; }
    .popup-reply button { padding:8px 12px; border-radius:8px; border:none; background:var(--green); color:#fff; font-weight:700; cursor:pointer; }

    /* arrows INSIDE wrap - visible on mobile and desktop (user requested) */
    .popup-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 60;
      background: rgba(255,255,255,0.06);
      border: none;
      color: rgba(255,255,255,0.92);
      backdrop-filter: blur(2px);
      width: 44px;
      height: 44px;
      border-radius: 44px;
      display: flex; /* visible everywhere now */
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:22px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transition: transform .12s ease, background .12s ease, opacity .12s;
      opacity: 0.86;
    }
    .popup-arrow:hover { transform: translateY(-50%) scale(1.06); background: rgba(255,255,255,0.10); }

    .popup-arrow.left { left: 12px; }
    .popup-arrow.right { right: 12px; }

    /* action bar (floating) */
    .popup-actions { position:absolute; left:12px; right:12px; bottom:18px; z-index:80; display:flex; gap:12px; justify-content:center; align-items:center; pointer-events:auto; }
    .popup-actions button { background:rgba(255,255,255,0.06); border:none; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; backdrop-filter: blur(4px); cursor:pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .popup-actions button:active { transform: scale(.98); }

    @media (max-width:480px){
      .post-box{ width:58%; }
      .comment-box{ width:40%; }
      .popup-media { max-height: 100%; }
      .popup-comments { max-height: 60vh; }
        .popup-arrow { display: none !important; pointer-events: none !important; opacity: 0 !important; }
      /* .popup-arrow { width:40px; height:40px; font-size:20px; } */
    }

    .hidden { display:none !important; }
    /* ---------- like heart burst + small pulse ---------- */
.burst-heart {
  position: fixed;
  pointer-events: none;
  transform: translate(-50%,-50%);
  font-size: 48px;
  line-height: 1;
  color: #ff4d6d;
  text-shadow: 0 6px 18px rgba(255,77,109,0.16);
  z-index: 5000;
  animation: heartPop 760ms cubic-bezier(.2,.9,.2,1) forwards;
}

@keyframes heartPop {
  0%   { transform: translate(-50%,-50%) scale(.45); opacity: 0; }
  20%  { transform: translate(-50%,-50%) scale(1.18); opacity: 1; }
  55%  { transform: translate(-50%,-110%) scale(1.0); opacity: 0.9; }
  100% { transform: translate(-50%,-220%) scale(.6); opacity: 0; }
}

/* subtle button pulse when liked */
.liked-pulse {
  animation: likedPulse 380ms cubic-bezier(.2,.9,.2,1);
}
@keyframes likedPulse {
  0%   { transform: scale(1); }
  45%  { transform: scale(1.14); }
  100% { transform: scale(1); }
}
/* Top loading progress bar */
#topProgress {
  position: fixed;
  left: 0;
  top: 0;
  height: 3px;
  width: 0%;
  background: linear-gradient(90deg, #00c853, #1b5e20);
  z-index: 9999;
  box-shadow: 0 2px 10px rgba(3, 155, 93, 0.12);
  transition: width 260ms linear, opacity 260ms ease;
  opacity: 0;
  pointer-events: none;
}
#topProgress.show { opacity: 1; }
#topProgress.finish {
  transition: width 160ms ease, opacity 420ms ease;
  background: linear-gradient(90deg,#00e676,#00c853);
}
@media (max-width:480px) {
  #popupPlayPauseBtn {
    display: none !important;
  }
}


  </style>
</head>
<body>
  <div class="app">

    <!-- fixed header -->
    <div class="top-left-header" aria-hidden="false" id="appHeader">
      <div style="display:flex;flex-direction:column;min-width:0;">
        <div class="brand">SHAKTI-IND</div>
        <div id="topLeftUserSmall" class="small-username" style="margin-top:2px;">Loading...</div>
      </div>
      <div class="top-search" role="search" aria-label="Search content, users, IDs">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#999" stroke-width="2"/></svg>
        <input id="globalSearch" placeholder="Search users, content, ID..." aria-label="Search users or content">
      </div>
    </div>

    <!-- story strip -->
    <div class="story-strip-wrapper">
      <div class="story-strip" id="storyStrip" role="list" aria-label="Categories">
        <!-- dynamically rebuilt -->
      </div>
    </div>

    <!-- main feed -->
    <div style="width:100%;max-width:720px;">
      <div class="main-feed-container" id="mainFeed">
        <div id="feed" class="feed-scroll-area"></div>
      </div>
    </div>

    <!-- popup overlay (fullscreen) -->
    <div id="postPopup" class="post-popup" aria-hidden="true" role="dialog" tabindex="-1">
      <div class="popup-inner" id="popupInner">
        <div class="popup-media-wrap" id="popupMediaWrap">
          <!-- blurred background for landscape videos -->
          <div id="popupBg" class="popup-bg" style="display:none;"></div>

          <!-- ARROWS moved here (inside wrap but outside .popup-media so they are not clipped) -->
          <button class="popup-arrow left" id="popupPrevBtn" aria-label="Previous">‚óÄ</button>
          <button class="popup-arrow right" id="popupNextBtn" aria-label="Next">‚ñ∂</button>

          <div class="popup-media" id="popupMedia">
            <div class="popup-top-controls">
              <button id="popupPlayPauseBtn" aria-label="Play/pause">‚è∏</button>
              <button id="popupCloseBtn" aria-label="Close">‚úï</button>
            </div>

            <div id="popupMediaHolder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"></div>

            <!-- action bar (overlay) - horizontal like / comment / share -->
            <div class="popup-actions" aria-hidden="false">
              <button id="popupLikeBtn" aria-label="Like">‚ô° Like</button>
              <button id="popupCommentBtn" aria-label="Comment">üí¨ Comment</button>
              <button id="popupShareBtn" aria-label="Share">‚Üó Share</button>
            </div>
          </div>

          <!-- comments area (collapsed by default). When opened it slides up -->
          <div class="popup-comments" id="popupComments" tabindex="0" aria-label="Comments">
            <div id="popupCommentsList" style="padding-bottom:6px;"></div>
            <div class="popup-reply">
              <input id="popupReplyInput" placeholder="Write a reply..." aria-label="Write a reply">
              <button id="popupReplyBtn">Reply</button>
            </div>
          </div>
          <div class="comment-handle" id="commentHandle"></div>
        </div>
      </div>
    </div>

    <!-- bottom nav -->
    <div class="bottom-nav">
      <div class="nav-inner">
        <div class="nav-item active" id="navHome"><span class="icon">üè†</span>Home</div>
        <div class="nav-item" id="navSafety"><span class="icon">üö®</span>Safety</div>
        <div class="nav-item" id="navPlus"><span class="icon" style="background:linear-gradient(90deg,var(--saffron),var(--green)); -webkit-background-clip:text; color:transparent;">Ôºã</span></div>
        <div class="nav-item" id="navCommunity"><span class="icon">üë•</span>Community</div>
        <div class="nav-item" id="navProfile"><span class="icon">üë§</span>Profile</div>
      </div>
    </div>

  </div>

<script>
  // -------------------------
  // Helpers
  // -------------------------
  document.getElementById('topLeftUserSmall').innerText =
    localStorage.getItem('user_session') || 'gowri_p08';

  function $(s, root = document) { return root.querySelector(s); }
  function $all(s, root = document) { return Array.from(root.querySelectorAll(s)); }

  // -------------------------
  // CHANGES: realistic user pool + neutral avatars
  // -------------------------
  const REALISTIC_USERNAMES = [
    "Aarav_21", "PriyaSharma", "RohanK", "Meera_88", "Siddharth", "Nitya", "Ananya_R", "Kiran.verma",
    "Somu_Reddy", "BhavyaS", "Ritu_Patel", "Ishaan", "NehaG", "Vikas_S", "Pooja89"
  ];

  function pickUser(){
    const i = Math.floor(Math.random() * REALISTIC_USERNAMES.length);
    const name = REALISTIC_USERNAMES[i];
    return {
      username: name,
      initials: getInitials(name)
    };
  }

  function getInitials(name){
    // take first two letters of first name-like token
    try {
      const tokens = name.split(/[_\.\- ]+/).filter(Boolean);
      if (!tokens.length) return name.slice(0,2).toUpperCase();
      const first = tokens[0];
      const sec = tokens[1] || '';
      const c1 = first.charAt(0) ? first.charAt(0).toUpperCase() : '';
      const c2 = sec.charAt(0) ? sec.charAt(0).toUpperCase() : (first.charAt(1) ? first.charAt(1).toUpperCase() : '');
      return (c1 + c2).slice(0,2);
    } catch(e){ return name.slice(0,2).toUpperCase(); }
  }

  // ========= FOLDER NAMES (exactly like in your /pics tree) =========
  const ALL_FOLDER_CATS = [
    "culture","economy","educational","entertainment","ethical",
    "health","legal","localnews","Nature","news",
    "shaktisafety","society","sports","students","technology"
  ];

  // mapping for UI display names
  const CAT_DISPLAY = {
    all: 'All',
    shaktisafety: 'Safety',
    health: 'Health',
    technology: 'Tech',
    nature: 'Nature',
    Nature: 'Nature',
    culture: 'Culture',
    localnews: 'Local'
  };

  const STORY_TO_FOLDER = {
    all: null,
    shaktisafety: "shaktisafety",
    health: "health",
    technology: "technology",
    nature: "Nature",
    culture: "culture",
    localnews: "localnews"
  };

  const PATH_PREFIXES = ["pics","./pics","/pics","../pics"];
  const EXTS = ["webm","mp4","jpg","jpeg","png","webp"];

  async function fileExists(url){
    try {
      const res = await fetch(url, { method: 'HEAD' });
      return res && res.ok;
    } catch(e){
      // HEAD might be blocked on some hosts; fallback to try GET small range would be heavier.
      return false;
    }
  }

  async function loadMediaForCategory(cat, maxCount = 12){
    if (!cat) return [];
    const out = [];
    for (const prefix of PATH_PREFIXES){
      let foundSomething = false;
      for (let i = 1; i <= maxCount; i++){
        for (const ext of EXTS){
          const path = `${prefix}/${cat}/${i}.${ext}`;
          /* eslint-disable no-await-in-loop */
          const ok = await fileExists(path);
          if (ok){
            const type = (ext === 'mp4' || ext === 'webm') ? 'video' : 'image';
            out.push({ path, type, ext, category: cat });
            foundSomething = true;
            break;
          }
        }
      }
      if (foundSomething) break;
    }
    return out;
  }

  // -------------------------
  // CHANGES: comment generation uses realistic names and neutral avatars
  // -------------------------
  function generateCommentsHTML(count){
    const names = ["Meera_88","Aarav_21","PriyaSharma","RohanK","Nitya","Kiran.verma","Somu_Reddy","BhavyaS"];
    const texts = ["This helped me understand so much, thank you!","Amazing shot ‚Äî the lighting is perfect! ‚ú®","Powerful message ‚Äî nicely said.","So inspiring ‚Äî keep sharing.","Looks delicious! üòã","Wow, didn't know this ‚Äî learned something new."];
    const times = ["just now","5m","12m","2d","Yesterday","3h"];
    let out = '';
    for (let i = 0; i < count; i++){
      const u = names[Math.floor(Math.random()*names.length)];
      const t = texts[Math.floor(Math.random()*texts.length)];
      const meta = times[Math.floor(Math.random()*times.length)];
      const initials = getInitials(u);
      out += `<div class="comment"><div class="comment-left"><div class="comment-user-pic" title="${u}">${initials}</div><div class="comment-body"><div class="comment-header-line"><span class="comment-username">${u}</span><button class="heart-small" title="Like">‚ô°</button></div><span class="comment-text">${t}</span><div class="comment-meta">${meta}</div></div></div></div>`;
    }
    return out;
  }

  // -------------------------
  // Build post HTML ‚Äî CHANGES: use post.username & initials for header avatar
  // -------------------------
  function buildPostHTML(post){
    // determine header avatar display (neutral background + initials)
    const initials = post.initials || getInitials(post.title || post.category || 'U');
    const avatarHtml = `<div class="post-user-pic" title="${post.username || post.title || ''}">${initials}</div>`;

    if (post.type === 'video'){
      return `
        <div class="post-header">
          ${avatarHtml}
          <div style="flex:1">
            <div class="post-username">${post.username || post.title}</div>
            <div class="post-time">${post.time}</div>
          </div>
        </div>
        <video
          class="post-video media-placeholder"
          data-src="${post.src}"
          ${post.poster ? `poster="${post.poster}"` : ''}
          preload="none"
          playsinline
          muted
          controls
        ></video>
        <div class="post-actions">
          <button class="action-btn like-btn">‚ô° Like</button>
          <button class="action-btn share-btn">üì§ Share</button>
        </div>
        <div class="post-hashtag">#${post.category}</div>
      `;
    } else {
      return `
        <div class="post-header">
          ${avatarHtml}
          <div style="flex:1">
            <div class="post-username">${post.username || post.title}</div>
            <div class="post-time">${post.time}</div>
          </div>
        </div>
        <img class="post-img media-placeholder" data-src="${post.src}" alt="${post.title}">
        <div class="post-actions">
          <button class="action-btn like-btn">‚ô° Like</button>
          <button class="action-btn share-btn">üì§ Share</button>
        </div>
        <div class="post-hashtag">#${post.category}</div>
      `;
    }
  }

  function buildFeedRow(post, index){
    const postHTML = `<div class="post-box">${buildPostHTML(post)}</div>`;
    const commentsHTML = `<div class="comment-box">${generateCommentsHTML(5)}</div>`;
    return (index % 2 === 0) ? `<div class="feed-row">${postHTML}${commentsHTML}</div>` : `<div class="feed-row">${commentsHTML}${postHTML}</div>`;
  }

  function sampleFallbackPosts(){
    // use realistic sample users
    const u1 = pickUser();
    const u2 = pickUser();
    return [
      { type:'image', src:'/pics/nature/1.jpg', username:u1.username, initials:u1.initials, title:'NATURE', category:'nature', time:'2h ago' },
      { type:'video', src:'/pics/culture/1.webm', username:u2.username, initials:u2.initials, title:'CULTURE', category:'culture', time:'20 hr ago' }
    ];
  }

  // -------------------------
  // Dynamic story strip builder
  // -------------------------
  function rebuildStoryStrip(presentCategories = []) {
    const wrapper = $('#storyStrip');
    wrapper.innerHTML = '';
    // Always show All first
    const items = [{ key:'all', label: CAT_DISPLAY.all || 'All' }];

    // Build items in a stable order: prefer STORY_TO_FOLDER keys and then other present categories
    const preferred = ['shaktisafety','health','technology','Nature','culture','localnews'];
    const added = new Set();

    for (const k of preferred) {
      if (presentCategories.includes(k)) {
        items.push({ key: k, label: CAT_DISPLAY[k] || (k.charAt(0).toUpperCase()+k.slice(1)) });
        added.add(k);
      }
    }
    // add any other present categories not in preferred
    for (const k of presentCategories) {
      if (!added.has(k)) items.push({ key: k, label: CAT_DISPLAY[k] || (k.charAt(0).toUpperCase()+k.slice(1)) });
    }

    // render
    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'story-item' + (idx===0 ? ' active' : '');
      div.dataset.cat = it.key;
      div.tabIndex = 0;
      div.role = 'button';
      div.innerText = it.label;
      div.addEventListener('click', async () => {
        $all('.story-item').forEach(x => x.classList.remove('active'));
        div.classList.add('active');
        const folderCat = STORY_TO_FOLDER[it.key] ?? (it.key === 'all' ? null : it.key);
        await generateFeed(folderCat);
      });
      wrapper.appendChild(div);
    });
  }

  // -------------------------
  // MAIN FEED GENERATOR
  // -------------------------
  async function generateFeed(folderCategory = null){
    const feed = $('#feed');
    feed.innerHTML = '';
    if (window.startLoadingBar) window.startLoadingBar();
    const catsToLoad = folderCategory ? [folderCategory] : ALL_FOLDER_CATS;
    let mediaItems = [];
    for (const folder of catsToLoad){
      const list = await loadMediaForCategory(folder, 12);
      list.forEach(m => {
        const type = m.type === 'video' ? 'video' : 'image';
        const poster = (type === 'video') ? m.path.replace(/\.(webm|mp4)$/i, '.jpg') : '';

        // CHANGES: pick a realistic username and attach initials to the post object
        const user = pickUser();
        mediaItems.push({
          type,
          src: m.path,
          poster,
          username: user.username,
          initials: user.initials,
          title: (user.username || folder).toUpperCase(),
          category: folder,
          time: `${Math.floor(Math.random()*23)+1} hr ago`
        });
      });
    }

    if (mediaItems.length === 0) mediaItems = sampleFallbackPosts();

    // keep order but mix a bit:
    mediaItems.sort(() => Math.random() - 0.5);

    // Build feed DOM
    mediaItems.forEach((post, i) => {
      const card = document.createElement('div');
      card.className = 'feed-card';
      card.innerHTML = buildFeedRow(post, i);
      feed.appendChild(card);
    });

    // assign feed indices to both images and videos
    assignFeedIndices();

    // Rebuild story strip to show only present categories (plus All)
    const present = Array.from(new Set(mediaItems.map(m=>m.category)));
    rebuildStoryStrip(present);

        attachFeedInteractions();
    window.__observeMedia?.();
    window.__setupSingleVideoAutoplay?.();
    if (window.finishLoadingBar) window.finishLoadingBar();

  }

  // assign incremental feed index to each media element (order in DOM) ‚Äî includes images & videos
  function assignFeedIndices(){
    const mediaEls = document.querySelectorAll('#feed video, #feed img');
    mediaEls.forEach((v, idx) => { v.dataset.feedIndex = idx; });
  }

  // -------------------------
  // Interactions (like, open popup, etc.)
  // -------------------------
  function commentLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = (btn.textContent === '‚ô°') ? '‚ô•' : '‚ô°';
  }

  function postLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = btn.textContent.includes('‚ô°') ? btn.textContent.replace('‚ô°','‚ô•') : btn.textContent.replace('‚ô•','‚ô°');
    btn.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:180});
  }

/* ---------- Top loading progress (dynamic colors + robust start/finish) ---------- */
(function(){
  const existing = document.getElementById('topProgress');
  if (!existing) {
    const el = document.createElement('div');
    el.id = 'topProgress';
    document.documentElement.appendChild(el);
  }
  let progressEl = document.getElementById('topProgress');
  let autoTickTimer = null;
  let isRunning = false;

  // possible gradient choices (you can tweak)
  const GRADIENTS = [
    'linear-gradient(90deg, #00c853, #1b5e20)',              // green
    'linear-gradient(90deg, #ff9933, #ff6a00)',              // saffron / orange
    'linear-gradient(90deg, #0d47a1, #ff9933)',              // navy blue -> saffron mix
    'linear-gradient(90deg, #00c853, #ff9933)',              // green -> orange
    'linear-gradient(90deg, #1b5e20, #0d47a1)'               // deep green -> navy
  ];

  function pickGradient(){
    return GRADIENTS[Math.floor(Math.random()*GRADIENTS.length)];
  }

  // start: show and begin auto-increment (idempotent)
  window.startLoadingBar = function(){
    if (!progressEl) progressEl = document.getElementById('topProgress');
    // if already running, don't restart (but still ensure it's visible)
    if (isRunning) {
      progressEl.classList.add('show');
      progressEl.style.opacity = '1';
      return;
    }
    isRunning = true;

    // pick a dynamic gradient
    progressEl.style.background = pickGradient();

    progressEl.classList.add('show');
    progressEl.classList.remove('finish');
    progressEl.style.opacity = '1';
    progressEl.style.width = '6%';
    // clear any previous timer
    clearInterval(autoTickTimer);
    autoTickTimer = setInterval(() => {
      try {
        const cur = parseFloat(progressEl.style.width) || 0;
        // increase slower as it approaches 85%
        const delta = cur < 60 ? (Math.random()*6 + 3) : (Math.random()*2 + 0.6);
        const next = Math.min(88, cur + delta);
        progressEl.style.width = next + '%';
      } catch(e){}
    }, 350);
  };

  // set explicit percent (0..100)
  window.setLoadingBar = function(pct){
    if (!progressEl) progressEl = document.getElementById('topProgress');
    pct = Math.max(0, Math.min(100, Number(pct) || 0));
    progressEl.style.width = pct + '%';
  };

  // finish: jump to 100, flash, hide
  window.finishLoadingBar = function(){
    if (!progressEl) progressEl = document.getElementById('topProgress');
    clearInterval(autoTickTimer);
    autoTickTimer = null;
    progressEl.classList.add('finish');
    // ensure it goes to 100%
    progressEl.style.width = '100%';
    // tiny flash (use a slightly different gradient to emphasize completion)
    try { progressEl.style.background = pickGradient(); } catch(e){}
    // after short delay fade out and fully reset
    setTimeout(() => {
      try {
        progressEl.style.opacity = '0';
        // reset after opacity gone
        setTimeout(() => {
          try {
            progressEl.classList.remove('show','finish');
            progressEl.style.width = '0%';
            progressEl.style.opacity = '';
            // clear running flag
            isRunning = false;
            // reset background to a default (so next start picks new)
            progressEl.style.background = '';
          } catch(e){}
        }, 420);
      } catch(e){}
    }, 260);
  };
})();


// show floating heart animation centered on the clicked element
function showLikeAnimation(evt) {
  try {
    // if event is a native mouse event, currentTarget is element; if called manually pass element
    const el = (evt && evt.currentTarget) ? evt.currentTarget : (evt && evt.target) ? evt.target : null;
    // find a sensible fallback position if el missing
    let x = window.innerWidth / 2, y = window.innerHeight / 2;
    if (el && el.getBoundingClientRect) {
      const r = el.getBoundingClientRect();
      x = r.left + r.width / 2;
      y = r.top + r.height / 2;
    }
    const heart = document.createElement('div');
    heart.className = 'burst-heart';
    heart.textContent = '‚ô•';
    heart.style.left = `${x}px`;
    heart.style.top = `${y}px`;
    document.body.appendChild(heart);
    // remove after animation
    setTimeout(() => { try { heart.remove(); } catch(e){} }, 820);

    // add small pulse to the clicked element for tactile feedback
    if (el && el.classList) {
      el.classList.add('liked-pulse');
      setTimeout(() => el.classList.remove('liked-pulse'), 420);
    }
  } catch (e) { /* silent */ }
}

function attachFeedInteractions(){
  // comment like buttons
  $all('.comment-box .heart-small').forEach(btn => {
    btn.removeEventListener('click', commentLikeHandler);
    btn.addEventListener('click', commentLikeHandler);
  });

  // helper to attach popup-opening handlers to a media element (image or video)
  function attachOpenHandlers(el){
    // remove any previous handlers to avoid duplicates
    el.removeEventListener('click', onPostMediaClick);
    el.removeEventListener('pointerup', onPostMediaClick);
    el.removeEventListener('touchend', onPostMediaClick);

    // Add multiple handlers: click (desktop), pointerup (Edge), touchend (mobile)
    el.addEventListener('click', onPostMediaClick);
    el.addEventListener('pointerup', onPostMediaClick, {passive:true});
    el.addEventListener('touchend', onPostMediaClick, {passive:true});

    // small local toggle (feed-level) ‚Äî doesn't open popup if user interacts with controls
    if (el.tagName === 'VIDEO'){
      el.addEventListener('click', (ev) => {
        try {
          if (el.paused) { el.play().catch(()=>{}); } else { el.pause(); }
        } catch(e){}
      });
    }
  }

  // ensure video and image elements are clickable and above overlays
  $all('.post-img, .post-video').forEach(el => {
    try {
      el.style.position = el.style.position || 'relative';
      el.style.zIndex = 2;
    } catch(e){}
    attachOpenHandlers(el);
  });

  // like buttons on post
  $all('.like-btn').forEach(btn => {
    btn.removeEventListener('click', postLikeHandler);
    btn.addEventListener('click', postLikeHandler);
    btn.removeEventListener('click', showLikeAnimation);
    btn.addEventListener('click', showLikeAnimation);
  });

  // MutationObserver to auto-bind future elements
  if (!window.__feedInteractionObserverAttached) {
    window.__feedInteractionObserverAttached = true;
    const observer = new MutationObserver(() => {
      $all('.post-img, .post-video').forEach(el => {
        el.removeEventListener('click', onPostMediaClick);
        el.removeEventListener('pointerup', onPostMediaClick);
        el.removeEventListener('touchend', onPostMediaClick);
        el.addEventListener('click', onPostMediaClick);
        el.addEventListener('pointerup', onPostMediaClick, {passive:true});
        el.addEventListener('touchend', onPostMediaClick, {passive:true});
      });
    });
    observer.observe(document.getElementById('feed') || document.body, { childList: true, subtree: true });
  }
}


  /* --------- Auto-play / single video logic (feed) --------- */
(function singleVideoAutoplay(){
  let currentlyPlaying = null;
  let observer = null;

  function playVideoEl(videoEl){
    if (!videoEl) return;
    try {
      document.querySelectorAll('#feed video').forEach(v => { if (v !== videoEl) try { v.pause(); v.dataset.isPlaying='false'; } catch(e){} });
      videoEl.muted = true;
      const p = videoEl.play();
      if (p && p.then) p.catch(()=>{});
      videoEl.dataset.isPlaying = 'true';
      currentlyPlaying = videoEl;
    } catch(e){}
  }

  function pauseVideoEl(videoEl){
    if (!videoEl) return;
    try { videoEl.pause(); videoEl.dataset.isPlaying='false'; } catch(e){}
    if (currentlyPlaying === videoEl) currentlyPlaying = null;
  }

  function switchTo(videoEl){
    if (currentlyPlaying && currentlyPlaying !== videoEl) pauseVideoEl(currentlyPlaying);
    if (videoEl && (videoEl.paused || videoEl.dataset.isPlaying !== 'true')) playVideoEl(videoEl);
  }

  function startObservingVideos(){
    if (observer) try { observer.disconnect(); } catch(e){}
    observer = null;

    const videos = Array.from(document.querySelectorAll('#feed video.post-video, #feed video'));
    if (!videos.length) return;
    if (!('IntersectionObserver' in window)){ switchTo(videos[0]); return; }

    observer = new IntersectionObserver((entries) => {
      const visible = entries.filter(e => e.isIntersecting).sort((a,b)=> b.intersectionRatio - a.intersectionRatio);
      if (visible.length === 0) return;
      const candidate = visible[0].target;
      switchTo(candidate);
    }, { root:null, rootMargin:'0px', threshold:[0,0.25,0.5,0.6,0.75,1] });

    videos.forEach(v => { v.playsInline = true; v.muted = true; observer.observe(v); });

    setTimeout(()=> {
      const firstVisible = videos.find(v => { const r=v.getBoundingClientRect(); return (r.top < window.innerHeight && r.bottom > 0); }) || videos[0];
      if (firstVisible) switchTo(firstVisible);
    }, 220);
  }

  window.__setupSingleVideoAutoplay = startObservingVideos;
  window.__pauseAutoplay = function(){ const cur = document.querySelector('#feed video[data-is-playing="true"]'); if (cur) try { cur.pause(); cur.dataset.isPlaying='false'; } catch(e){} };

  const popupCommentsArea = document.getElementById('popupComments');
  if (popupCommentsArea) popupCommentsArea.addEventListener('focusin', () => { const cur = document.querySelector('#feed video[data-is-playing="true"]'); if (cur) try { cur.pause(); cur.dataset.isPlaying='false'; } catch(e){} });

})();


  function findPostBoxFromMedia(el){ return el.closest('.post-box'); }
  function onPostMediaClick(e){ const mediaEl = e.currentTarget; openPopupWithMedia(mediaEl); }

  // -------------------------
  // POPUP LOGIC (full-screen + swipe prev/next)
  // -------------------------
  const popup = $('#postPopup');
  const popupMediaHolder = $('#popupMediaHolder');
  const popupCommentsList = $('#popupCommentsList');
  const popupCommentsArea = $('#popupComments');
  const popupReplyInput = $('#popupReplyInput');
  const popupReplyBtn = $('#popupReplyBtn');
  const popupCloseBtn = $('#popupCloseBtn');
  const popupPlayPauseBtn = $('#popupPlayPauseBtn');
  const popupPrevBtn = $('#popupPrevBtn');
  const popupNextBtn = $('#popupNextBtn');
  const commentHandle = $('#commentHandle');

  /***** NEW: popup action buttons and media container references *****/
  const popupLikeBtn = $('#popupLikeBtn');
  const popupCommentBtn = $('#popupCommentBtn');
  const popupShareBtn = $('#popupShareBtn');
  const popupMedia = $('#popupMedia');
  const popupMediaWrap = $('#popupMediaWrap');
  const popupCommentsEl = $('#popupComments');
  const popupBg = $('#popupBg');
  const popupInner = $('#popupInner');

  let popupPlayingVideo = null;
  let popupSourcePostBox = null;
  let feedMediaSources = []; // ordered list of feed media srcs (images + videos)
  let currentPopupIndex = -1;

  // build ordered list of feed media (use dataset.src/source.src)
  function refreshFeedMediaSources(){
    const mediaEls = Array.from(document.querySelectorAll('#feed video, #feed img'));
    feedMediaSources = mediaEls.map((el, idx) => {
      const s = el.dataset.src || el.querySelector('source')?.src || el.src || '';
      const t = el.tagName.toLowerCase() === 'video' ? 'video' : 'image';
      return { src: s, feedIndex: parseInt(el.dataset.feedIndex || -1), poster: el.getAttribute('poster') || '' , postBox: el.closest('.feed-card'), type: t };
    });
  }

  // show a particular index inside popup (replaces popup media and comments)
  function showPopupIndex(idx){
    if (idx < 0 || idx >= feedMediaSources.length) return;
    currentPopupIndex = idx;

    // stop previous popup video
    if (popupPlayingVideo){
      try{ popupPlayingVideo.pause(); popupPlayingVideo.src=''; } catch(e){}
      popupPlayingVideo = null;
    }

    // reset background
    if (popupBg) { popupBg.style.display = 'none'; popupBg.style.backgroundImage = ''; }

    popupMediaHolder.innerHTML = '';
    const info = feedMediaSources[idx];

    if (!info || !info.src) return;
    const isImage = /\.(jpe?g|png|webp|jpeg)$/i.test(info.src);

    if (isImage) {
      const img = document.createElement('img');
      img.src = info.src;
      img.style.objectFit = 'cover';
      img.setAttribute('alt', info.src);
      popupMediaHolder.appendChild(img);
      popupPlayingVideo = null;
      popupPlayPauseBtn.style.display = 'none';
    } else {
      const video = document.createElement('video');
      video.controls = true;
      video.playsInline = true;
      video.preload = 'auto';
      video.autoplay = true;
      video.loop = false;
      video.style.width = '100%';
      video.style.height = '100%';
      video.muted = true; // start muted to satisfy autoplay on mobile
      video.style.maxWidth = '100%';
      video.style.maxHeight = '100%';
      video.style.objectFit = 'cover'; // default; may change after metadata
      const source = document.createElement('source');
      source.src = info.src;
      video.appendChild(source);
      if (info.poster) video.setAttribute('poster', info.poster);

      // clicking video toggles play/pause; if comments open, it closes comments first
      video.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (popupCommentsEl && popupCommentsEl.classList.contains("open")) {
          // close comments on tapping video if comments open (common UX)
          closeComments();
          return;
        }
        if (video.paused) {
          video.play().catch(()=>{});
          if (popupPlayPauseBtn) popupPlayPauseBtn.textContent = "‚è∏";
        } else {
          video.pause();
          if (popupPlayPauseBtn) popupPlayPauseBtn.textContent = "‚ñ∂";
        }
      });

      // When metadata loaded, decide fit mode: landscape -> contain + blurred background; portrait -> cover
      video.addEventListener('loadedmetadata', () => {
        try {
          const vidAR = video.videoWidth / (video.videoHeight || 1);
          const winAR = window.innerWidth / (window.innerHeight || 1);
          // If video is wider than screen (landscape), use contain + blurred background
          if (vidAR > winAR * 1.05) {
            video.style.objectFit = 'contain';
            const bgUrl = info.poster || info.src;
            if (bgUrl && popupBg) {
              popupBg.style.backgroundImage = `url("${bgUrl}")`;
              popupBg.style.display = 'block';
            }
          } else {
            video.style.objectFit = 'cover';
            if (popupBg) popupBg.style.display = 'none';
          }
        } catch(e){}
      });

      // AUTO MOVE TO NEXT WHEN VIDEO ENDS
      video.addEventListener('ended', () => {
        setTimeout(()=> navigatePopup(1), 260);
      });

      popupMediaHolder.appendChild(video);
      popupPlayingVideo = video;
      // attempt play
      video.play().then(()=> {
        setTimeout(()=> { try{ video.muted = false; } catch(e){} }, 300);
      }).catch(()=>{});
      popupPlayPauseBtn.style.display = 'inline-block';
      popupPlayPauseBtn.textContent = '‚è∏';
    }

    // populate comments for that feed card (if available)
    popupCommentsList.innerHTML = '';
    try {
      const postCard = info.postBox;
      if (postCard){
        const feedComments = postCard.querySelectorAll('.comment');
        feedComments.forEach(c => {
          const username = c.querySelector('.comment-username')?.innerText || 'User';
          const text = c.querySelector('.comment-text')?.innerText || '';
          const meta = c.querySelector('.comment-meta')?.innerText || '';
          const initials = (username) ? (username.split(/[_\.\- ]+/)[0].slice(0,1).toUpperCase() + (username.split(/[_\.\- ]+/)[1]?.slice(0,1)?.toUpperCase()||'')) : 'U';
          const div = document.createElement('div');
          div.className = 'popup-comment';
          div.innerHTML = `<div class="avatar">${initials}</div>
                           <div class="body"><div style="font-weight:700">${escapeHtml(username)}</div><div style="margin-top:6px">${escapeHtml(text)}</div>
                           <div class="meta">${escapeHtml(meta)} <button class="like">‚ô°</button></div></div>`;
          popupCommentsList.appendChild(div);
        });
      } else {
        // fallback: some dummy comments so UI doesn't feel empty
        popupCommentsList.innerHTML = generateCommentsHTML(6);
      }
    } catch(e){
      popupCommentsList.innerHTML = generateCommentsHTML(6);
    }

    // attach like handlers for newly created likes
    $all('.popup-comment .like').forEach(btn => { btn.onclick = popupCommentLikeHandler; });
  }

  // Open popup and show specific media element
  function openPopupWithMedia(mediaEl){
    // pause feed autoplay
    if (window.__pauseAutoplay) window.__pauseAutoplay();

    // refresh ordered feed sources (and feedIndex assignments)
    assignFeedIndices();
    refreshFeedMediaSources();

    // determine which index this mediaEl corresponds to
    const feedIndex = parseInt(mediaEl.dataset.feedIndex || -1);
    let idx = feedMediaSources.findIndex(s => s.feedIndex === feedIndex);
    if (idx === -1) {
      // fallback: match by src
      const src = mediaEl.dataset.src || mediaEl.querySelector('source')?.src || mediaEl.src || '';
      idx = feedMediaSources.findIndex(s => s.src === src);
    }
    if (idx === -1) idx = 0;

    popupSourcePostBox = findPostBoxFromMedia(mediaEl);
    // lock background scroll for better fullscreen experience
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    popup.style.display = 'block';
    popup.setAttribute('aria-hidden','false');

    // ensure comments closed
    closeComments();
    showPopupIndex(idx);
    attachPopupHandlers();
  }

  // helper to open comments (shrinks the media area & shows comments)
  function openComments(){
    if (!popup) return;
    const media = popupMedia;
    const mediaWrap = popupMediaWrap;
    // add class to make media top-aligned and slightly smaller
    media.classList.add('comments-open');
    // set css var so .popup-media height accounts for comment area
    document.documentElement.style.setProperty('--popup-comments-height', '36vh');
    // open the comments panel
    popupCommentsEl.classList.add('open');
    // ensure the comment handle shows
    document.querySelector('.comment-handle')?.classList.add('visible');
    // pause popup playing video
    if (popupPlayingVideo && !popupPlayingVideo.paused) {
      try { popupPlayingVideo.pause(); popupPlayPauseBtn.textContent = '‚ñ∂'; } catch(e){}
    }
    // focus the input after animation
    setTimeout(()=> { try { popupReplyInput.focus(); } catch(e){} }, 260);
  }

  // helper to close comments (restore media area)
  function closeComments(){
    if (!popup) return;
    popupMedia.classList.remove('comments-open');
    document.documentElement.style.setProperty('--popup-comments-height', '0vh');
    popupCommentsEl.classList.remove('open');
    document.querySelector('.comment-handle')?.classList.remove('visible');
    // do not automatically resume playback ‚Äî leave to user
  }

  function attachPopupHandlers(){
    // prevent duplicate attachments by clearing previous listeners where necessary

    // touch swipe handlers for next/prev
    let startX = 0, startY = 0, isMoving = false;
    const threshold = 50; // px to consider swipe

    function onTouchStart(e){
      const t = e.touches ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : null);
      if (!t) return;
      startX = t.clientX;
      startY = t.clientY;
      isMoving = true;
    }
    function onTouchMove(e){
      if (!isMoving || !e.touches) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 6) e.preventDefault();
    }
    function onTouchEnd(e){
      if (!isMoving) return;
      isMoving = false;
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      const endX = t ? t.clientX : startX;
      const dx = endX - startX;
      if (dx > threshold) navigatePopup(-1);
      else if (dx < -threshold) navigatePopup(1);
    }

    // overlay click closes popup when clicking outside media wrap
    function onOverlayClick(ev){
      const target = ev.target;
      // If click happened inside the media wrap (arrows, top controls, actions, or media) don't close
      if (target.closest && target.closest('.popup-media-wrap')) return;
      closePopup();
    }

    // bind once to the popupMediaWrap (touch + swipe)
    const mediaWrap = $('#popupMediaWrap') || $('#popupMedia');
    if (mediaWrap) {
      mediaWrap.removeEventListener('touchstart', onTouchStart);
      mediaWrap.removeEventListener('touchmove', onTouchMove);
      mediaWrap.removeEventListener('touchend', onTouchEnd);
      mediaWrap.addEventListener('touchstart', onTouchStart, {passive:false});
      mediaWrap.addEventListener('touchmove', onTouchMove, {passive:false});
      mediaWrap.addEventListener('touchend', onTouchEnd);
    }

    popup.removeEventListener('click', onOverlayClick);
    popup.addEventListener('click', onOverlayClick);

    // arrows (prev/next)
    popupPrevBtn.removeEventListener('click', onPrev);
    popupNextBtn.removeEventListener('click', onNext);
    popupPrevBtn.addEventListener('click', onPrev);
    popupNextBtn.addEventListener('click', onNext);

    // play/pause
    popupPlayPauseBtn.removeEventListener('click', togglePopupPlayPause);
    popupPlayPauseBtn.addEventListener('click', togglePopupPlayPause);

    // close
    popupCloseBtn.removeEventListener('click', closePopup);
    popupCloseBtn.addEventListener('click', closePopup);

    // comments area focus (pauses video)
    popupCommentsArea.removeEventListener('click', pauseVideoOnCommentFocus);
    popupCommentsArea.addEventListener('click', pauseVideoOnCommentFocus);
    popupCommentsArea.removeEventListener('focusin', pauseVideoOnCommentFocus);
    popupCommentsArea.addEventListener('focusin', pauseVideoOnCommentFocus);

    popupReplyBtn.onclick = onPopupReply;
    popupReplyInput.onkeydown = e => { if(e.key === 'Enter') onPopupReply(); };

    $all('.popup-comment .like').forEach(btn => { btn.onclick = popupCommentLikeHandler; });

    document.removeEventListener('keydown', popupKeyHandler);
    document.addEventListener('keydown', popupKeyHandler);

    // helper handler functions
    function onPrev(e){ e.stopPropagation(); navigatePopup(-1); }
    function onNext(e){ e.stopPropagation(); navigatePopup(1); }

    // bottom comment button opens/hides comments
    if (popupCommentBtn) {
      popupCommentBtn.removeEventListener('click', popupCommentBtnHandler);
      popupCommentBtn.addEventListener('click', popupCommentBtnHandler);
    }
    function popupCommentBtnHandler(e){
      e.stopPropagation();
      const c = $('#popupComments');
      if (!c) return;
      const isOpen = c.classList.toggle('open');
      if (isOpen) {
        openComments();
      } else {
        closeComments();
      }
    }

    /***** action bar wiring (Like / Comment / Share) *****/
    if (popupLikeBtn) {
      popupLikeBtn.removeEventListener('click', popupLikeHandlerSafe);
      popupLikeBtn.addEventListener('click', popupLikeHandlerSafe);
      popupLikeBtn.removeEventListener('click', showLikeAnimation);
      popupLikeBtn.addEventListener('click', showLikeAnimation);
    }
    function popupLikeHandlerSafe(e){
      e.stopPropagation();
      if (!popupLikeBtn) return;
      if (popupLikeBtn.textContent.includes('‚ô°')) popupLikeBtn.innerHTML = '‚ô• Liked';
      else popupLikeBtn.innerHTML = '‚ô° Like';
    }

    if (popupShareBtn) {
      popupShareBtn.removeEventListener('click', popupShareHandler);
      popupShareBtn.addEventListener('click', popupShareHandler);
    }
    function popupShareHandler(e){
      e.stopPropagation();
      try {
        if (navigator.share && feedMediaSources[currentPopupIndex]) {
          navigator.share({ title: document.title, url: feedMediaSources[currentPopupIndex].src }).catch(()=>{});
        } else {
          alert('Share: ' + (feedMediaSources[currentPopupIndex]?.src || window.location.href));
        }
      } catch(err){}
    }

    // When comments are open and user taps anywhere on the media area, close comments (and do not toggle play)
    if (popupMedia) {
      popupMedia.removeEventListener('click', mediaAreaClickHandler);
      popupMedia.addEventListener('click', mediaAreaClickHandler);
    }
    function mediaAreaClickHandler(ev){
      const c = $('#popupComments');
      if (c && c.classList.contains('open')) {
        // if user taps media while comments are open, close comments (UX: easier to return to fullscreen)
        closeComments();
        ev.stopPropagation();
        ev.preventDefault();
        return;
      }
    }

  }

  function popupKeyHandler(e){ if (e.key === 'Escape') closePopup(); }

  function navigatePopup(direction){
    const next = currentPopupIndex + direction;
    if (next < 0 || next >= feedMediaSources.length) return;
    showPopupIndex(next);
  }

  function pauseVideoOnCommentFocus(){
    if (popupPlayingVideo && !popupPlayingVideo.paused){
      popupPlayingVideo.pause();
      popupPlayPauseBtn.textContent = '‚ñ∂';
    }
  }

  function togglePopupPlayPause(e){
    e && e.stopPropagation();
    if (!popupPlayingVideo) return;
    if (popupPlayingVideo.paused){
      popupPlayingVideo.play().catch(()=>{});
      popupPlayPauseBtn.textContent = '‚è∏';
    } else {
      popupPlayingVideo.pause();
      popupPlayPauseBtn.textContent = '‚ñ∂';
    }
  }

  function popupCommentLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = (btn.textContent === '‚ô°') ? '‚ô•' : '‚ô°';
  }

  function onPopupReply(){
    const text = popupReplyInput.value.trim();
    if (!text) return;
    const name = localStorage.getItem('user_session') || 'You';
    const initials = getInitials(name);
    const div = document.createElement('div');
    div.className = 'popup-comment';
    div.innerHTML = `<div class="avatar" style="background:var(--avatar-bg);color:var(--avatar-fg)">${initials}</div>
                     <div class="body"><div style="font-weight:700">${escapeHtml(name)}</div><div style="margin-top:6px">${escapeHtml(text)}</div>
                     <div class="meta">just now <button class="like">‚ô°</button></div></div>`;
        popupCommentsList.prepend(div);
    const likeBtn = div.querySelector('.like'); if (likeBtn) likeBtn.onclick = popupCommentLikeHandler;

    // ensure comments panel scrolls to top so the newly-prepended comment is visible
    // use a tiny timeout to allow layout to settle on some browsers
    try {
      setTimeout(() => {
        // popupCommentsEl is the scroll container for comments
        if (popupCommentsEl && typeof popupCommentsEl.scrollTop !== 'undefined') {
          popupCommentsEl.scrollTop = 0;
        } else if (popupCommentsList && typeof popupCommentsList.scrollTop !== 'undefined') {
          popupCommentsList.scrollTop = 0;
        }
      }, 40);
    } catch(e){}

    // mirror into feed comments of the source post if visible
    const info = feedMediaSources[currentPopupIndex];
    if (info && info.postBox){
      const feedCommentBox = info.postBox.querySelector('.comment-box');
      if (feedCommentBox){
        const feedDiv = document.createElement('div');
        feedDiv.className = 'comment';
        feedDiv.innerHTML = `<div class="comment-left"><div class="comment-user-pic">${initials}</div>
                             <div class="comment-body"><div class="comment-header-line"><span class="comment-username">${escapeHtml(name)}</span>
                             <button class="heart-small" title="Like">‚ô°</button></div><span class="comment-text">${escapeHtml(text)}</span>
                             <div class="comment-meta">just now</div></div></div>`;
        feedCommentBox.prepend(feedDiv);
        const newLikeBtn = feedDiv.querySelector('.heart-small');
        if (newLikeBtn) newLikeBtn.addEventListener('click', commentLikeHandler);
      }
    }

    popupReplyInput.value = '';
    pauseVideoOnCommentFocus();
  }

  function closePopup(){
    if (popupPlayingVideo){
      try { popupPlayingVideo.pause(); popupPlayingVideo.src = ''; } catch(e){}
      popupPlayingVideo = null;
    }
    // hide bg too
    if (popupBg) { popupBg.style.display = 'none'; popupBg.style.backgroundImage = ''; }
    // ensure comments closed and CSS var reset
    closeComments();
    popup.style.display = 'none';
    popup.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', popupKeyHandler);
    // restore scrolling
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    // after closing, let feed autoplay pick up again
    setTimeout(()=> window.__setupSingleVideoAutoplay?.(), 200);
  }

  // -------------------------
  // Lazy loading with IntersectionObserver
  // -------------------------
  (function lazyObserve(){
    const io = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const el = entry.target;
        io.unobserve(el);
        if (el.tagName === 'IMG'){
          const ds = el.dataset.src;
          if (ds){ el.src = ds; el.removeAttribute('data-src'); }
          el.classList.remove('skeleton');
        } else if (el.tagName === 'VIDEO'){
          const ds = el.dataset.src;
          if (ds){
            if (!el.querySelector('source')){
              const src = document.createElement('source');
              src.src = ds;
              el.appendChild(src);
            } else {
              el.querySelector('source').src = ds;
            }
            el.preload = 'auto';
            el.muted = true;
            try { el.load(); } catch(e){}
          }
          el.classList.remove('skeleton');
        }
      });
    }, { root:null, rootMargin:'300px 0px', threshold:0.01 });

    window.__observeMedia = () => {
      $all('img[data-src], video[data-src]').forEach(el => {
        el.classList.add('skeleton');
        io.observe(el);
      });
    };
  })();

  // bottom nav basic highlight (no routing yet)
  function setActiveNav(id){
    $all('.nav-item').forEach(n => n.classList.remove('active'));
    const el = document.getElementById(id); if (el) el.classList.add('active');
  }
  $('#navHome').addEventListener('click', ()=> setActiveNav('navHome'));
  $('#navSafety').addEventListener('click', ()=> setActiveNav('navSafety'));
  $('#navCommunity').addEventListener('click', ()=> setActiveNav('navCommunity'));
  $('#navProfile').addEventListener('click', ()=> setActiveNav('navProfile'));

  // -------------------------
  // Init on load: show ALL (all folders in /pics)
  // -------------------------
 window.addEventListener('load', async () => {
  document.documentElement.style.setProperty('--popup-comments-height', '0vh');

  // show top loader while we generate feed
  if (window.startLoadingBar) window.startLoadingBar();

  await generateFeed(null);        // null => all folders

  setTimeout(() => { assignFeedIndices(); window.__observeMedia?.(); window.__setupSingleVideoAutoplay?.(); 
    // finish loader after UI initializes
    if (window.finishLoadingBar) window.finishLoadingBar();
  }, 250);
});


  // small util
  function escapeHtml(text){
    return String(text || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]));
  }
</script>

</body>
</html>
