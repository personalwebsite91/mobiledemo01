<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <title>SHAKTI-IND ‚Äî Mobile</title>
  <style>
    :root{
      --bg:#ffffff;
      --saffron:#FF9933;
      --green:#138808;
      --card:#ffffff;
      --muted:#777;
      --popup-comments-height: 0vh; /* toggled by JS (0 or 36vh) */
      --avatar-bg: #f3f4f6; /* neutral avatar background */
      --avatar-fg: #1f2937; /* avatar text color */
      --headline-blue: #0047FF; /* NEW: headline / quick category color */
    }
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);-webkit-text-size-adjust:none;color:#111;}
    .app { min-height:100vh; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; }

    /* hide scrollbars visually (but keep scrolling) */
    * { scrollbar-width: none; -ms-overflow-style: none; }
    *::-webkit-scrollbar { display: none; }

    /* header */
    .top-left-header{
      position:fixed;
      left: env(safe-area-inset-left, 12px);
      top: calc(env(safe-area-inset-top, 12px));
      right: 0px;
      z-index:1400;
      display:flex;
      align-items:center;
      gap:80px;
      background: rgba(255,255,255,0.98);
      padding:10px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      box-sizing:border-box;
      max-width: calc(100%-8px);
      transition: transform 160ms ease, padding 160ms ease;
    }
    .brand { font-weight:900; font-size:18px; letter-spacing:1px;
      background:linear-gradient(90deg,var(--saffron) 50%, var(--green) 50%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
       white-space:nowrap;
    }
    .small-username{ font-size:12px; color:#111; font-weight:700; margin-top:2px; }
    .top-search { flex:1; display:flex; align-items:center; gap:8px; background:#f6f6f6; padding:8px; border-radius:10px; }
    .top-search input{ border:none; outline:none; background:transparent; font-size:13px; width:100%; min-width:0; }

    /* story strip */
    .story-strip-wrapper { width:100%; max-width:720px; margin-top: calc( (env(safe-area-inset-top, 12px) + 6px) + 64px - 10px ); box-sizing:border-box; padding:6px 12px 0; }
    .story-strip { display:flex; gap:10px; padding:10px 4px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .story-item { min-width:72px; flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px; border-radius:999px; background:#fff; box-shadow:0 6px 12px rgba(0,0,0,0.04); text-align:center; font-size:12px; cursor:pointer; white-space:nowrap; border:1px solid rgba(0,0,0,0.03); }
    .story-item.active { outline: 2px solid rgba(19,136,8,0.12); box-shadow:0 8px 18px rgba(19,136,8,0.06); font-weight:700; }

    /* feed main */
    .main-feed-container{ width:100%; max-width:720px; padding: 8px 12px 120px; box-sizing:border-box; margin-top:6px; }
    .feed-card{ background:var(--card); border-radius:14px; padding:12px; box-shadow:0 6px 24px rgba(0,0,0,0.06); margin-bottom:18px; overflow:visible; }
    .feed-row{ display:flex; gap:14px; align-items:flex-start; box-sizing:border-box; flex-direction:row; }
    .post-box{ width:55%; background:#fafafa; border-radius:12px; padding:10px; box-sizing:border-box; box-shadow:0 3px 10px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:8px; }
    .comment-box{ width:45%; background:var(--card); border-radius:12px; padding:8px; box-sizing:border-box; border:1px solid #f0f0f0; max-height:320px; overflow:auto; }

    .post-header{ display:flex; gap:8px; align-items:center; }
    /* replaced colorful gradient with neutral avatar style */
    .post-user-pic{ width:36px; height:36px; border-radius:50%; background:var(--avatar-bg); color:var(--avatar-fg); flex:0 0 36px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; }
    .post-username{ font-weight:600; font-size:13px; color:#222; margin:0; }
    .post-time{ font-size:11px; color:var(--muted); margin-top:2px; }
    .post-img, .post-video { width:100%; border-radius:10px; display:block; object-fit:cover; cursor:pointer; max-height:420px; }

    .post-actions{ display:flex; gap:8px; align-items:center; justify-content:flex-start; font-size:13px; color:var(--muted); }
    .action-btn{ background:none; border:none; font-weight:600; cursor:pointer; padding:6px; border-radius:8px }
    .post-hashtag{ color:var(--green); font-weight:700; font-size:12px; margin-top:6px; }

    .comment{ display:flex; gap:8px; align-items:flex-start; margin-bottom:10px; justify-content:flex-start; }
    .comment-left{ display:flex; gap:8px; align-items:flex-start; flex:1; min-width:0; }
    /* comment avatars neutral as well */
    .comment-user-pic{ width:18px; height:18px; border-radius:50%; flex:0 0 18px; margin-top:2px; background:var(--avatar-bg); color:var(--avatar-fg); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; }
    .comment-body{ min-width:0; flex:1; }
    .comment-header-line{ display:flex; align-items:center; justify-content:space-between; gap:4px; }
    .comment-username{ font-weight:600; font-size:12px; color:#222; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .comment-text{ font-size:12px; color:#444; display:block; margin-top:2px; white-space:normal; }
    .comment-meta{ font-size:10px; color:var(--muted); margin-top:4px; }
    .heart-small{ background:transparent; border:none; font-size:13px; cursor:pointer; padding:0 4px; color:#d33; }

    /* bottom navbar */
    .bottom-nav{ position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom,0); height:62px; background:var(--card); display:flex; align-items:center; justify-content:center; box-shadow:0 -10px 30px rgba(0,0,0,0.06); z-index:1100; padding-bottom: calc(env(safe-area-inset-bottom, 0px)); }
    .nav-inner{ max-width:720px; width:100%; display:flex; justify-content:space-around; align-items:center; padding:6px 12px; box-sizing:border-box; }
    .nav-item{ font-size:14px; color:#666; text-align:center; flex:1; cursor:pointer; }
    .nav-item .icon{ display:block; font-size:18px; margin-bottom:2px }
    .nav-item.active{ color:var(--green); font-weight:700; }

    /* skeleton shimmer */
    .skeleton { background: linear-gradient(90deg,#f2f2f2 0%, #ececec 50%, #f6f6f6 100%); background-size: 200% 100%; animation: skeleton-shimmer 1.2s linear infinite; border-radius: 10px; }
    @keyframes skeleton-shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }

    /* ------------------- POPUP (FULLSCREEN) ------------------- */
    .post-popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: stretch;
      justify-content: center;
      z-index: 3000;
      background: rgba(0,0,0,0.95);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      padding: 0;
      box-sizing: border-box;
    }

    .popup-inner {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: transparent;
      border-radius: 0;
      overflow: hidden;
      position: relative;
    }

    /* media area covers the whole screen (behind comments) */
    .popup-media-wrap {
      position: relative;
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden;
      background: #000;
    }

    .popup-bg {
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center center;
      filter: blur(22px) saturate(120%);
      transform: scale(1.08);
      opacity:0.98;
      z-index:10;
      transition: opacity 220ms ease;
    }

    .popup-media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: calc(100% - var(--popup-comments-height)); /* shrink when comments open */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      z-index:20;
      transition: height 260ms cubic-bezier(.2,.9,.2,1), padding 220ms ease, transform 220ms ease;
      padding-top: 0;
    }

    /* When comments are open we want media to be top-aligned & smaller */
    .popup-media.comments-open {
      align-items:flex-start;
      justify-content:center;
      padding-top:22px;
      /* add a tiny translateY so it looks like it moves up when comments open */
      transform: translateY(-6px);
      /* background-color: white; */
    }

    /* VIDEO/IMG styling inside popup holder */
    .popup-media video,
    .popup-media img {
      max-width:94%;
      max-height: calc(100% - 40px);
      display:block;
      z-index:22;
      background:#000;
      border-radius:12px;
      transition: width 220ms ease, height 220ms ease, object-fit 160ms ease, transform 180ms ease;
      object-fit: cover;
    }

    /* If comments open, reduce media size slightly */
    .popup-media.comments-open video,
    .popup-media.comments-open img {
      max-width: 86%;
      max-height: calc(100% - 8px); /* leave small gap above comment area */
      border-radius:10px;
      background-color: white;
    }

    /* top controls: close / play / arrows */
    .popup-top-controls{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      gap:8px;
      z-index:60;
      align-items:center;
    }
    .popup-top-controls button{ background: rgba(255,255,255,0.08); border:none; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }

    /* comment toggle handle (hidden until tapped) */
    .popup-comments {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 0;               /* start hidden */
      max-height: 60vh;
      overflow: auto;
      background:grey;
      color: #f7f7f7;
      transition: height 260ms cubic-bezier(.2,.9,.2,1), padding 180ms ease;
      z-index:70;
      box-sizing:border-box;
      padding: 0 12px;
    }
    .popup-comments.open { height: 36vh; padding: 12px; } /* visible state */

    /* bottom comment handle visible above the fold */
    .comment-handle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(36vh - 12px); /* when open it sits above comment box; but hidden by default */
      width: 56px;
      height: 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.12);
      z-index: 80;
      display: none;
    }
    .popup-comments.open + .comment-handle { display:block; }

    .popup-comment { display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
    .popup-comment .avatar { width:28px; height:28px; border-radius:50%; flex:0 0 28px; background:var(--avatar-bg); color:var(--avatar-fg); display:flex; align-items:center; justify-content:center; font-weight:700; }
    .popup-comment .body { flex:1; max-width: calc(100% - 40px); }
    .popup-comment .meta { font-size:12px; color: #ddd; margin-top:6px; display:flex; align-items:center; gap:8px; }
    .popup-comment .like { background:transparent; border:none; color:#ff6b6b; font-size:16px; cursor:pointer; }

    .popup-reply { display:flex; gap:8px; margin-top:8px; align-items:center; position:sticky; bottom:6px; background:transparent; padding-bottom:8px; }
    .popup-reply input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2); color:#fff; }
    .popup-reply button { padding:8px 12px; border-radius:8px; border:none; background:var(--green); color:#fff; font-weight:700; cursor:pointer; }

    /* arrows INSIDE wrap - visible on mobile and desktop (user requested) */
    .popup-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 60;
      background: rgba(255,255,255,0.06);
      border: none;
      color: rgba(255,255,255,0.92);
      backdrop-filter: blur(2px);
      width: 44px;
      height: 44px;
      border-radius: 44px;
      display: flex; /* visible everywhere now */
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:22px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transition: transform .12s ease, background .12s ease, opacity .12s;
      opacity: 0.86;
    }

    .popup-arrow:hover { transform: translateY(-50%) scale(1.06); background: rgba(255,255,255,0.10); }

    .popup-arrow.left { left: 12px; }
    .popup-arrow.right { right: 12px; }
    /* action bar (floating) - made smaller, tighter spacing */
    .popup-actions {
      position:absolute;
      left:12px;
      right:12px;
      bottom:18px;
      z-index:80;
      display:flex;
      gap:8px; /* reduced gap */
      justify-content:center;
      align-items:center;
      pointer-events:auto;
      transition: opacity 220ms ease, transform 220ms ease;
    }
    .popup-actions button {
      background:rgba(255,255,255,0.06);
      border:none;
      color:#fff;
      padding:6px 10px; /* smaller */
      border-radius:999px;
      font-weight:700;
      font-size:13px; /* smaller */
      backdrop-filter: blur(4px);
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .popup-actions button:active { transform: scale(.98); }

    /* hidden state */
    .popup-actions.actions-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
    }

    @media (max-width:480px){
      .post-box{ width:58%; }
      .comment-box{ width:40%; }
      .popup-media { max-height: 100%; }
      .popup-comments { max-height: 60vh; }
        /* .popup-arrow { display: none !important; pointer-events: none !important; opacity: 0 !important; } */
      .popup-arrow { width:40px; height:40px; font-size:10px; }
    }

    .hidden { display:none !important; }
    /* ---------- like heart burst + small pulse ---------- */
    .burst-heart {
      position: fixed;
      pointer-events: none;
      transform: translate(-50%,-50%);
      font-size: 48px;
      line-height: 1;
      color: #ff4d6d;
      text-shadow: 0 6px 18px rgba(255,77,109,0.16);
      z-index: 5000;
      animation: heartPop 760ms cubic-bezier(.2,.9,.2,1) forwards;
    }

    @keyframes heartPop {
      0%   { transform: translate(-50%,-50%) scale(.45); opacity: 0; }
      20%  { transform: translate(-50%,-50%) scale(1.18); opacity: 1; }
      55%  { transform: translate(-50%,-110%) scale(1.0); opacity: 0.9; }
      100% { transform: translate(-50%,-220%) scale(.6); opacity: 0; }
    }

    /* subtle button pulse when liked */
    .liked-pulse {
      animation: likedPulse 380ms cubic-bezier(.2,.9,.2,1);
    }
    @keyframes likedPulse {
      0%   { transform: scale(1); }
      45%  { transform: scale(1.14); }
      100% { transform: scale(1); }
    }
    /* Top loading progress bar */
    #topProgress {
      position: fixed;
      left: 0;
      top: 0;
      height: 3px;
      width: 0%;
      background: linear-gradient(90deg, #00c853, #1b5e20);
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(3, 155, 93, 0.12);
      transition: width 260ms linear, opacity 260ms ease;
      opacity: 0;
      pointer-events: none;
    }
    #topProgress.show { opacity: 1; }
    #topProgress.finish {
      transition: width 160ms ease, opacity 420ms ease;
      background: linear-gradient(90deg,#00e676,#00c853);
    }
    @media (max-width:480px) {
      #popupPlayPauseBtn {
        display: none !important;
      }
    }
    /* Music button styling + spin when active */
    .popup-actions #popupMusicBtn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      border: none;
      color: #fff;
      font-weight:700;
      cursor: pointer;
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      font-size:13px;
    }

    .popup-actions #popupMusicBtn.music-active {
      background: linear-gradient(90deg, rgba(255,153,51,0.12), rgba(19,136,8,0.12));
    }

    /* tiny rotating icon effect for the emoji */
    .popup-actions #popupMusicBtn.music-active::before {
      content: 'üéß';
      display:inline-block;
      margin-right:6px;
      animation: musicSpin 1600ms linear infinite;
      transform-origin: 50% 50%;
    }

    @keyframes musicSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* small toast used to show track name (inserted by JS) */
    #musicToast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 10px) + 84px);
      background: rgba(0,0,0,0.72);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      z-index: 99999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 220ms ease, transform 220ms ease;
    }
    #musicToast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }

  /* Safety map specific small styles */
  #safetyMap { width:100%; height: 44vh; border-radius:10px; background: #f7fafc; /* subtle neutral bg while tiles load */ }
  .safety-card { background:#fff; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-top:12px; }
  /* Make grid 2x2 fixed tiles (not scrollable) */
  .cat-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:12px; }
  .cat-box { background:#fff; padding:14px; border-radius:12px; cursor:pointer; border:1px solid rgba(0,0,0,0.04); box-shadow:0 6px 14px rgba(0,0,0,0.04); min-height:82px; display:flex; flex-direction:column; justify-content:center; transition: transform 160ms ease, box-shadow 160ms ease; }
  .cat-box:hover { transform: translateY(-4px); box-shadow:0 10px 26px rgba(0,0,0,0.08); }
  /* NEW: quick category headline color to blue like page headlines */
  .cat-box strong { font-size:15px; display:block; color: var(--headline-blue); }
  .cat-box p { margin:6px 0 0; color:var(--muted); font-size:13px; }
  .cat-detail { background:#fafafa; padding:12px; border-radius:10px; margin-top:10px; }
  .back-x { background:#fff; border-radius:8px; padding:6px 10px; border:none; cursor:pointer; font-weight:700; }
  .leaflet-container { border-radius:10px; }
  @media (max-width:480px) {
    #safetyMap { height:38vh; }
    .cat-box { min-height:72px; padding:12px; }
  }

  /* Notification bubble (floating) */
  .safety-notification-bubble {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 40;
    background: linear-gradient(90deg,#ff6b6b,#ff4d4d);
    color: #fff;
    padding: 8px 10px;
    border-radius: 999px;
    font-weight:800;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 8px 22px rgba(255,77,109,0.14);
    cursor:pointer;
    font-size:12px; /* small text as requested */
    border: 2px solid rgba(255,255,255,0.15);
  }
  .safety-notification-bubble .dot { width:10px;height:10px;border-radius:10px;background:#fff;opacity:0.95; }

  /* Notification modal */
  .safety-notif-modal {
    position: fixed;
    left: 12px;
    right: 12px;
    top: 12vh;
    max-height: 66vh;
    overflow:auto;
    margin: 0 auto;
    z-index: 5000;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.28);
    padding: 14px;
  }
  .safety-notif-modal h3 { margin:0 0 8px; font-size:16px; }
  .safety-notif-list { display:flex; flex-direction:column; gap:8px; margin-top:10px; }
  .safety-notif-item { padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.04); background:#fafafa; font-size:13px; }
  .safety-notif-close { position:absolute; top:10px; right:12px; background:transparent; border:none; font-size:20px; cursor:pointer; }

  /* make the Live label small */
  .safety-live-small { font-weight:800; color:#ff2d2d; font-size:13px; margin-right:8px; }
  .safety-live-line { font-size:13px; color:#111; font-weight:700; }
  .small-live{margin-top: 50px;}
.safety-code-box {
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
  border:1px solid rgba(0,0,0,0.06);
}

.safety-code-box .title {
  font-weight:700;
  color:#000;
  font-size:15px;
  margin-bottom:4px;
}

.safety-code-box .desc {
  color:#555;
  font-size:13px;
  margin-bottom:10px;
}

.safety-code-box .activateBtn {
  background:linear-gradient(90deg,#007bff,#0056d2);
  color:#fff;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,123,255,0.2);
}

  </style>
</head>
<body>
  <div class="app">

    <!-- fixed header -->

    <!-- story strip -->
    

    <!-- MAIN CONTENT REGION (we will swap this inner HTML for Safety or Home) -->
    <div id="mainContentWrapper" style="width:100%;max-width:720px;">
        <div class="top-left-header" aria-hidden="false" id="appHeader">
      <div style="display:flex;flex-direction:column;min-width:0;">
        <div class="brand">SHAKTI-IND</div>
        <div id="topLeftUserSmall" class="small-username" style="margin-top:2px;">Loading...</div>
      </div>
      <div class="top-search" role="search" aria-label="Search content, users, IDs">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#999" stroke-width="2"/></svg>
        <input id="globalSearch" placeholder="Search users, content, ID..." aria-label="Search users or content">
      </div>
    </div>
      <div class="story-strip-wrapper">
      <div class="story-strip" id="storyStrip" role="list" aria-label="Categories">
        <!-- dynamically rebuilt -->
      </div>
    </div>
      <div class="main-feed-container" id="mainFeed">
        <div id="feed" class="feed-scroll-area"></div>
      </div>
    </div>

    <!-- popup overlay (fullscreen) -->
    <div id="postPopup" class="post-popup" aria-hidden="true" role="dialog" tabindex="-1">
      <div class="popup-inner" id="popupInner">
        <div class="popup-media-wrap" id="popupMediaWrap">
          <!-- blurred background for landscape videos -->
          <div id="popupBg" class="popup-bg" style="display:none;"></div>

          <!-- ARROWS moved here (inside wrap but outside .popup-media so they are not clipped) -->
          <button class="popup-arrow left" id="popupPrevBtn" aria-label="Previous">‚óÄ</button>
          <button class="popup-arrow right" id="popupNextBtn" aria-label="Next">‚ñ∂</button>

          <div class="popup-media" id="popupMedia">
            <div class="popup-top-controls">
              <button id="popupPlayPauseBtn" aria-label="Play/pause">‚è∏</button>
              <button id="popupCloseBtn" aria-label="Close">‚úï</button>
            </div>

            <div id="popupMediaHolder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"></div>

            <!-- action bar (overlay) - horizontal like / comment / share / music -->
            <div class="popup-actions" aria-hidden="false">
              <button id="popupLikeBtn" aria-label="Like">‚ô° Like</button>
              <button id="popupCommentBtn" aria-label="Comment">üí¨ Comment</button>
              <button id="popupMusicBtn" aria-label="Music">üéµ Music</button>
              <button id="popupShareBtn" aria-label="Share">‚Üó Share</button>
            </div>
          </div>

          <!-- comments area (collapsed by default). When opened it slides up -->
          <div class="popup-comments" id="popupComments" tabindex="0" aria-label="Comments">
            <div id="popupCommentsList" style="padding-bottom:6px;"></div>
            <div class="popup-reply">
              <input id="popupReplyInput" placeholder="Write a reply..." aria-label="Write a reply">
              <button id="popupReplyBtn">Reply</button>
            </div>
          </div>
          <div class="comment-handle" id="commentHandle"></div>
        </div>
      </div>
    </div>

    <!-- SHAKTI CODE POPUP (persistent, global) -->
    <div id="shaktiPopup"
         style="position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 99999;">
      <div style="width: 92%; max-width:1100px; height: 88%; background: #fff; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.35);">
        <button id="shaktiPopupClose" aria-label="Close Shakti" style="position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(0,0,0,0.9); color: #fff; border: none; padding: 6px 10px; font-size: 16px; border-radius: 6px; cursor: pointer;">‚úï</button>
       <iframe
        id="shaktiFrame"
        src=""
        allow="microphone; camera; autoplay; encrypted-media"
        allowfullscreen
        style="width:100%;height:100%;border:none;"
    ></iframe>
      </div>
    </div>

    <!-- bottom nav -->
    <div class="bottom-nav">
      <div class="nav-inner">
        <div class="nav-item active" id="navHome" data-page="home"><span class="icon">üè†</span>Home</div>
        <div class="nav-item" id="navSafety" data-page="safety"><span class="icon">üö®</span>Safety</div>
        <div class="nav-item" id="navPlus" data-page="plus"><span class="icon" style="background:linear-gradient(90deg,var(--saffron),var(--green)); -webkit-background-clip:text; color:transparent;">CHATS</span></div>
        <div class="nav-item" id="navCommunity" data-page="community"><span class="icon">üë•</span>Community</div>
        <div class="nav-item" id="navProfile" data-page="profile"><span class="icon">üë§</span>Profile</div>
      </div>
    </div>

  </div>

<script>
  // -------------------------
// Cloudinary helpers
// -------------------------
function buildCloudEmbedUrl(item) {
  if (!item) return null;
  // Use embed_url if provided, but ensure autoplay + muted params
  if (item.embed_url) {
    try {
      const url = new URL(item.embed_url);
      // Only set if not already present
      if (!url.searchParams.has('autoplay')) url.searchParams.set('autoplay', 'true');
      if (!url.searchParams.has('muted')) url.searchParams.set('muted', 'false');
      if (!url.searchParams.has('loop')) url.searchParams.set("loop", "true");;
      return url.toString();
    } catch (err) {
      // fallback if URL fails to parse
      const sep = item.embed_url.includes('?') ? '&' : '?';
      return item.embed_url + sep + 'autoplay=true&muted=true';
    }
  }
  if (item.cloud_name && item.public_id) {
    // also add autoplay+muted here
    return `https://player.cloudinary.com/embed/?cloud_name=${encodeURIComponent(item.cloud_name)}&public_id=${encodeURIComponent(item.public_id)}&profile=cld-default&autoplay=true&muted=true`;
  }
  return null;
}


  // -------------------------
  // Helpers
  // -------------------------
  document.getElementById('topLeftUserSmall').innerText =
    localStorage.getItem('user_session') || 'gowri_p08';

  function $(s, root = document) { return root.querySelector(s); }
  function $all(s, root = document) { return Array.from(root.querySelectorAll(s)); }

  // -------------------------
  // CHANGES: realistic user pool + neutral avatars
  // (unchanged from your original - kept as-is)
  // -------------------------
  const REALISTIC_USERNAMES = [
    "Aarav_21", "PriyaSharma", "RohanK", "Meera_88", "Siddharth", "Nitya", "Ananya_R", "Kiran.verma",
    "Somu_Reddy", "BhavyaS", "Ritu_Patel", "Ishaan", "NehaG", "Vikas_S", "Pooja89"
  ];

  function pickUser(){
    const i = Math.floor(Math.random() * REALISTIC_USERNAMES.length);
    const name = REALISTIC_USERNAMES[i];
    return {
      username: name,
      initials: getInitials(name)
    };
  }

  function getInitials(name){
    try {
      const tokens = name.split(/[_\.\- ]+/).filter(Boolean);
      if (!tokens.length) return name.slice(0,2).toUpperCase();
      const first = tokens[0];
      const sec = tokens[1] || '';
      const c1 = first.charAt(0) ? first.charAt(0).toUpperCase() : '';
      const c2 = sec.charAt(0) ? sec.charAt(0).toUpperCase() : (first.charAt(1) ? first.charAt(1).toUpperCase() : '');
      return (c1 + c2).slice(0,2);
    } catch(e){ return name.slice(0,2).toUpperCase(); }
  }

  // ========= FOLDER NAMES (unchanged)
  const ALL_FOLDER_CATS = [
    "culture","economy","educational","entertainment","ethical",
    "health","legal","localnews","Nature","news",
    "shaktisafety","society","sports","students","technology"
  ];

  const CAT_DISPLAY = {
    all: 'All',
    shaktisafety: 'Safety',
    health: 'Health',
    technology: 'Tech',
    nature: 'Nature',
    Nature: 'Nature',
    culture: 'Culture',
    localnews: 'Local'
  };

  const STORY_TO_FOLDER = {
    all: null,
    shaktisafety: "shaktisafety",
    health: "health",
    technology: "technology",
    nature: "Nature",
    culture: "culture",
    localnews: "localnews"
  };

  const PATH_PREFIXES = ["pics","./pics","/pics","../pics"];
  const EXTS = ["webm","mp4","jpg","jpeg","png","webp"];

  async function fileExists(url){
    try {
      const res = await fetch(url, { method: 'HEAD' });
      return res && res.ok;
    } catch(e){
      return false;
    }
  }

  async function loadMediaForCategory(cat, maxCount = 12){
    if (!cat) return [];
    const out = [];
    for (const prefix of PATH_PREFIXES){
      let foundSomething = false;
      for (let i = 1; i <= maxCount; i++){
        for (const ext of EXTS){
          const path = `${prefix}/${cat}/${i}.${ext}`;
          const ok = await fileExists(path);
          if (ok){
            const type = (ext === 'mp4' || ext === 'webm') ? 'video' : 'image';
            out.push({ path, type, ext, category: cat });
            foundSomething = true;
            break;
          }
        }
      }
      if (foundSomething) break;
    }
    return out;
  }

  // -------------------------
  // generateCommentsHTML, buildPostHTML, buildFeedRow, etc.
  // (kept unchanged ‚Äî original code)
  // -------------------------
  
  function generateCommentsHTML(count){
    const names = ["Meera_88","Aarav_21","PriyaSharma","RohanK","Nitya","Kiran.verma","Somu_Reddy","BhavyaS"];
    const texts = ["This helped me understand so much, thank you!","Amazing shot ‚Äî the lighting is perfect! ‚ú®","Powerful message ‚Äî nicely said.","So inspiring ‚Äî keep sharing.","Looks delicious! üòã","Wow, didn't know this ‚Äî learned something new."];
    const times = ["just now","5m","12m","2d","Yesterday","3h"];
    let out = '';
    for (let i = 0; i < count; i++){
      const u = names[Math.floor(Math.random()*names.length)];
      const t = texts[Math.floor(Math.random()*texts.length)];
      const meta = times[Math.floor(Math.random()*times.length)];
      const initials = getInitials(u);
      out += `<div class="comment"><div class="comment-left"><div class="comment-user-pic" title="${u}">${initials}</div><div class="comment-body"><div class="comment-header-line"><span class="comment-username">${u}</span><button class="heart-small" title="Like">‚ô°</button></div><span class="comment-text">${t}</span><div class="comment-meta">${meta}</div></div></div></div>`;
    }
    return out;
  }

 function buildPostHTML(post){
  const initials = post.initials || getInitials(post.title || post.category || 'U');
  const avatarHtml = `<div class="post-user-pic" title="${post.username || post.title || ''}">${initials}</div>`;

  if (post.type === 'cloud-video' || post.type === 'video') {
    // cloud-video: embed is iframe in popup only; in feed we show poster + play overlay (click opens popup).
    // native video: keep existing <video> element behavior.
    if (post.type === 'cloud-video') {
      // use poster if available, otherwise fallback to a gray box
      const posterAttr = post.poster ? `style="background-image:url('${post.poster}');background-size:cover;background-position:center;height:220px;border-radius:10px;"` : `style="background:#000;height:220px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff"`;
      // data-src holds the embed url so popup can detect it
      return `
        <div class="post-header">
          ${avatarHtml}
          <div style="flex:1">
            <div class="post-username">${post.username || post.title}</div>
            <div class="post-time">${post.time}</div>
          </div>
        </div>

        <div class="post-video media-placeholder cloud-video-poster" data-src="${post.src}" ${posterAttr} aria-label="Cloudinary video: ${escapeHtml(post.title || '')}">
          <div style="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
            <div style="width:68px;height:68px;border-radius:50%;background:rgba(0,0,0,0.48);display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.18)">‚ñ∂</div>
          </div>
        </div>

        <div class="post-actions">
          <button class="action-btn like-btn">‚ô° Like</button>
          <button class="action-btn share-btn">üì§ Share</button>
        </div>
        <div class="post-hashtag">#${post.category}</div>
      `;
    } else {
      // native video (unchanged)
      return `
        <div class="post-header">
          ${avatarHtml}
          <div style="flex:1">
            <div class="post-username">${post.username || post.title}</div>
            <div class="post-time">${post.time}</div>
          </div>
        </div>
        <video
          class="post-video media-placeholder"
          data-src="${post.src}"
          ${post.poster ? `poster="${post.poster}"` : ''}
          preload="none"
          playsinline
          muted
          controls
        ></video>
        <div class="post-actions">
          <button class="action-btn like-btn">‚ô° Like</button>
          <button class="action-btn share-btn">üì§ Share</button>
        </div>
        <div class="post-hashtag">#${post.category}</div>
      `;
    }
  } else {
    // image branch unchanged
    return `
      <div class="post-header">
        ${avatarHtml}
        <div style="flex:1">
          <div class="post-username">${post.username || post.title}</div>
          <div class="post-time">${post.time}</div>
        </div>
      </div>
      <img class="post-img media-placeholder" data-src="${post.src}" alt="${post.title}">
      <div class="post-actions">
        <button class="action-btn like-btn">‚ô° Like</button>
        <button class="action-btn share-btn">üì§ Share</button>
      </div>
      <div class="post-hashtag">#${post.category}</div>
    `;
  }
}


  function buildFeedRow(post, index){
    const postHTML = `<div class="post-box">${buildPostHTML(post)}</div>`;
    const commentsHTML = `<div class="comment-box">${generateCommentsHTML(5)}</div>`;
    return (index % 2 === 0) ? `<div class="feed-row">${postHTML}${commentsHTML}</div>` : `<div class="feed-row">${commentsHTML}${postHTML}</div>`;
  }

  function sampleFallbackPosts(){
    const u1 = pickUser();
    const u2 = pickUser();
    return [
      { type:'image', src:'/pics/nature/1.jpg', username:u1.username, initials:u1.initials, title:'NATURE', category:'nature', time:'2h ago' },
      { type:'video', src:'/pics/culture/1.webm', username:u2.username, initials:u2.initials, title:'CULTURE', category:'culture', time:'20 hr ago' }
    ];
  }

  // -------------------------
  // Dynamic story strip builder
  // -------------------------
  function rebuildStoryStrip(presentCategories = []) {
    const wrapper = $('#storyStrip');
    if (!wrapper) return;
    wrapper.innerHTML = '';
    const items = [{ key:'all', label: CAT_DISPLAY.all || 'All' }];
    const preferred = ['shaktisafety','health','technology','Nature','culture','localnews'];
    const added = new Set();
    for (const k of preferred) {
      if (presentCategories.includes(k)) {
        items.push({ key: k, label: CAT_DISPLAY[k] || (k.charAt(0).toUpperCase()+k.slice(1)) });
        added.add(k);
      }
    }
    for (const k of presentCategories) {
      if (!added.has(k)) items.push({ key: k, label: CAT_DISPLAY[k] || (k.charAt(0).toUpperCase()+k.slice(1)) });
    }
    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'story-item' + (idx===0 ? ' active' : '');
      div.dataset.cat = it.key;
      div.tabIndex = 0;
      div.role = 'button';
      div.innerText = it.label;
      div.addEventListener('click', async () => {
        $all('.story-item').forEach(x => x.classList.remove('active'));
        div.classList.add('active');
        const folderCat = STORY_TO_FOLDER[it.key] ?? (it.key === 'all' ? null : it.key);
        await generateFeed(folderCat);
      });
      wrapper.appendChild(div);
    });
  }

  // -------------------------
  // MAIN FEED GENERATOR
  // -------------------------
  async function generateFeed(folderCategory = null){
  const feed = $('#feed');
  if (!feed) return;
  feed.innerHTML = '';
  if (window.startLoadingBar) window.startLoadingBar();

  // Attempt to fetch videos.json (if present). It's optional.
  let cloudDb = { categories: [] };
  try {
    const r = await fetch('videos.json', { cache: 'no-cache' });
    if (r.ok) cloudDb = await r.json();
  } catch(e){
    // no videos.json or failed ‚Äî fall back to local /pics scanning
    cloudDb = { categories: [] };
  }

  const catsToLoad = folderCategory ? [folderCategory] : ALL_FOLDER_CATS;
  let mediaItems = [];

  // First: load Cloudinary items from videos.json for requested categories
  try {
    for (const folder of catsToLoad) {
      const catEntry = (cloudDb.categories || []).find(c => String((c.category||'').toLowerCase()) === String((folder||'').toLowerCase()));
      if (catEntry && Array.isArray(catEntry.videos)) {
        catEntry.videos.forEach(v => {
          const embed = buildCloudEmbedUrl(v);
          if (!embed) return;
          const poster = v.poster || (v.public_id ? `https://res.cloudinary.com/${v.cloud_name}/image/upload/v1/${v.public_id}.jpg` : '');
          const user = pickUser();
          mediaItems.push({
            type: 'cloud-video',
            src: embed,
            poster,
            username: user.username,
            initials: user.initials,
            title: (v.title || user.username || folder).toUpperCase(),
            category: folder,
            time: `${Math.floor(Math.random()*23)+1} hr ago`
          });
        });
      }
    }
  } catch(e){
    console.warn('cloud read error', e);
  }

  // Second: still try to load local /pics if no cloud items exist for category (preserves existing behavior)
  if (mediaItems.length === 0) {
    for (const folder of catsToLoad){
      const list = await loadMediaForCategory(folder, 12);
      list.forEach(m => {
        const type = m.type === 'video' ? 'video' : 'image';
        const poster = (type === 'video') ? m.path.replace(/\.(webm|mp4)$/i, '.jpg') : '';
        const user = pickUser();
        mediaItems.push({
          type,
          src: m.path,
          poster,
          username: user.username,
          initials: user.initials,
          title: (user.username || folder).toUpperCase(),
          category: folder,
          time: `${Math.floor(Math.random()*23)+1} hr ago`
        });
      });
    }
  }

  if (mediaItems.length === 0) mediaItems = sampleFallbackPosts();
  mediaItems.sort(() => Math.random() - 0.5);

  mediaItems.forEach((post, i) => {
    const card = document.createElement('div');
    card.className = 'feed-card';
    card.innerHTML = buildFeedRow(post, i);
    feed.appendChild(card);
  });

  assignFeedIndices();
  const present = Array.from(new Set(mediaItems.map(m=>m.category)));
  rebuildStoryStrip(present);

  attachFeedInteractions();
  window.__observeMedia?.();
  window.__setupSingleVideoAutoplay?.();
  if (window.finishLoadingBar) window.finishLoadingBar();
}


 function assignFeedIndices(){
  // include cloud posters, images and videos
  const mediaEls = document.querySelectorAll('#feed .post-video, #feed .post-img, #feed .cloud-video-poster, #feed video, #feed img');
  mediaEls.forEach((v, idx) => { v.dataset.feedIndex = idx; });
}


  // -------------------------
  // Interactions (like, open popup, etc.)
  // -------------------------
  function commentLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = (btn.textContent === '‚ô°') ? '‚ô•' : '‚ô°';
  }

  function postLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = btn.textContent.includes('‚ô°') ? btn.textContent.replace('‚ô°','‚ô•') : btn.textContent.replace('‚ô•','‚ô°');
    btn.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:180});
  }

  /* ---------- Top loading progress (dynamic colors + robust start/finish) ---------- */
  (function(){
    const existing = document.getElementById('topProgress');
    if (!existing) {
      const el = document.createElement('div');
      el.id = 'topProgress';
      document.documentElement.appendChild(el);
    }
    let progressEl = document.getElementById('topProgress');
    let autoTickTimer = null;
    let isRunning = false;

    const GRADIENTS = [
      'linear-gradient(90deg, #00c853, #1b5e20)',
      'linear-gradient(90deg, #ff9933, #ff6a00)',
      'linear-gradient(90deg, #0d47a1, #ff9933)',
      'linear-gradient(90deg, #00c853, #ff9933)',
      'linear-gradient(90deg, #1b5e20, #0d47a1)'
    ];

    function pickGradient(){
      return GRADIENTS[Math.floor(Math.random()*GRADIENTS.length)];
    }

    window.startLoadingBar = function(){
      if (!progressEl) progressEl = document.getElementById('topProgress');
      if (isRunning) {
        progressEl.classList.add('show');
        progressEl.style.opacity = '1';
        return;
      }
      isRunning = true;
      progressEl.style.background = pickGradient();
      progressEl.classList.add('show');
      progressEl.classList.remove('finish');
      progressEl.style.opacity = '1';
      progressEl.style.width = '6%';
      clearInterval(autoTickTimer);
      autoTickTimer = setInterval(() => {
        try {
          const cur = parseFloat(progressEl.style.width) || 0;
          const delta = cur < 60 ? (Math.random()*6 + 3) : (Math.random()*2 + 0.6);
          const next = Math.min(88, cur + delta);
          progressEl.style.width = next + '%';
        } catch(e){}
      }, 350);
    };

    window.setLoadingBar = function(pct){
      if (!progressEl) progressEl = document.getElementById('topProgress');
      pct = Math.max(0, Math.min(100, Number(pct) || 0));
      progressEl.style.width = pct + '%';
    };

    window.finishLoadingBar = function(){
      if (!progressEl) progressEl = document.getElementById('topProgress');
      clearInterval(autoTickTimer);
      autoTickTimer = null;
      progressEl.classList.add('finish');
      progressEl.style.width = '100%';
      try { progressEl.style.background = pickGradient(); } catch(e){}
      setTimeout(() => {
        try {
          progressEl.style.opacity = '0';
          setTimeout(() => {
            try {
              progressEl.classList.remove('show','finish');
              progressEl.style.width = '0%';
              progressEl.style.opacity = '';
              isRunning = false;
              progressEl.style.background = '';
            } catch(e){}
          }, 420);
        } catch(e){}
      }, 260);
    };
  })();

  // show floating heart animation centered on the clicked element
  function showLikeAnimation(evt) {
    try {
      const el = (evt && evt.currentTarget) ? evt.currentTarget : (evt && evt.target) ? evt.target : null;
      let x = window.innerWidth / 2, y = window.innerHeight / 2;
      if (el && el.getBoundingClientRect) {
        const r = el.getBoundingClientRect();
        x = r.left + r.width / 2;
        y = r.top + r.height / 2;
      }
      const heart = document.createElement('div');
      heart.className = 'burst-heart';
      heart.textContent = '‚ô•';
      heart.style.left = `${x}px`;
      heart.style.top = `${y}px`;
      document.body.appendChild(heart);
      setTimeout(() => { try { heart.remove(); } catch(e){} }, 820);
      if (el && el.classList) {
        el.classList.add('liked-pulse');
        setTimeout(() => el.classList.remove('liked-pulse'), 420);
      }
    } catch (e) { /* silent */ }
  }

  function attachFeedInteractions(){
    $all('.comment-box .heart-small').forEach(btn => {
      btn.removeEventListener('click', commentLikeHandler);
      btn.addEventListener('click', commentLikeHandler);
    });

    function attachOpenHandlers(el){
      el.removeEventListener('click', onPostMediaClick);
      el.removeEventListener('pointerup', onPostMediaClick);
      el.removeEventListener('touchend', onPostMediaClick);

      el.addEventListener('click', onPostMediaClick);
      el.addEventListener('pointerup', onPostMediaClick, {passive:true});
      el.addEventListener('touchend', onPostMediaClick, {passive:true});

      if (el.tagName === 'VIDEO'){
        el.addEventListener('click', (ev) => {
          try {
            if (el.paused) { el.play().catch(()=>{}); } else { el.pause(); }
          } catch(e){}
        });
      }
    }

    $all('.post-img, .post-video').forEach(el => {
      try {
        el.style.position = el.style.position || 'relative';
        el.style.zIndex = 2;
      } catch(e){}
      attachOpenHandlers(el);
    });
      // cloud poster click -> open popup
  $all('.cloud-video-poster').forEach(el => {
    // ensure dataset.feedIndex is set by assignFeedIndices; also attach click for opening popup
    el.removeEventListener('click', onPostMediaClick);
    el.addEventListener('click', onPostMediaClick, {passive:true});
    // make it look clickable
    el.style.cursor = 'pointer';
  });


    $all('.like-btn').forEach(btn => {
      btn.removeEventListener('click', postLikeHandler);
      btn.addEventListener('click', postLikeHandler);
      btn.removeEventListener('click', showLikeAnimation);
      btn.addEventListener('click', showLikeAnimation);
    });

    if (!window.__feedInteractionObserverAttached) {
      window.__feedInteractionObserverAttached = true;
      const observer = new MutationObserver(() => {
        $all('.post-img, .post-video').forEach(el => {
          el.removeEventListener('click', onPostMediaClick);
          el.removeEventListener('pointerup', onPostMediaClick);
          el.removeEventListener('touchend', onPostMediaClick);
          el.addEventListener('click', onPostMediaClick);
          el.addEventListener('pointerup', onPostMediaClick, {passive:true});
          el.addEventListener('touchend', onPostMediaClick, {passive:true});
        });
      });
      observer.observe(document.getElementById('feed') || document.body, { childList: true, subtree: true });
    }
  }

  /* --------- Auto-play / single video logic (feed) --------- */
  (function singleVideoAutoplay(){
    let currentlyPlaying = null;
    let observer = null;

    function playVideoEl(videoEl){
      if (!videoEl) return;
      try {
        document.querySelectorAll('#feed video').forEach(v => { if (v !== videoEl) try { v.pause(); v.dataset.isPlaying='false'; } catch(e){} });
        videoEl.muted = true;
        const p = videoEl.play();
        if (p && p.then) p.catch(()=>{});
        videoEl.dataset.isPlaying = 'true';
        currentlyPlaying = videoEl;
      } catch(e){}
    }

    function pauseVideoEl(videoEl){
      if (!videoEl) return;
      try { videoEl.pause(); videoEl.dataset.isPlaying='false'; } catch(e){}
      if (currentlyPlaying === videoEl) currentlyPlaying = null;
    }

    function switchTo(videoEl){
      if (currentlyPlaying && currentlyPlaying !== videoEl) pauseVideoEl(currentlyPlaying);
      if (videoEl && (videoEl.paused || videoEl.dataset.isPlaying !== 'true')) playVideoEl(videoEl);
    }

    function startObservingVideos(){
      if (observer) try { observer.disconnect(); } catch(e){}
      observer = null;

      const videos = Array.from(document.querySelectorAll('#feed video.post-video, #feed video'));
      if (!videos.length) return;
      if (!('IntersectionObserver' in window)){ switchTo(videos[0]); return; }

      observer = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting).sort((a,b)=> b.intersectionRatio - a.intersectionRatio);
        if (visible.length === 0) return;
        const candidate = visible[0].target;
        switchTo(candidate);
      }, { root:null, rootMargin:'0px', threshold:[0,0.25,0.5,0.6,0.75,1] });

      videos.forEach(v => { v.playsInline = true; v.muted = true; observer.observe(v); });

      setTimeout(()=> {
        const firstVisible = videos.find(v => { const r=v.getBoundingClientRect(); return (r.top < window.innerHeight && r.bottom > 0); }) || videos[0];
        if (firstVisible) switchTo(firstVisible);
      }, 220);
    }

    window.__setupSingleVideoAutoplay = startObservingVideos;
    window.__pauseAutoplay = function(){ const cur = document.querySelector('#feed video[data-is-playing="true"]'); if (cur) try { cur.pause(); cur.dataset.isPlaying='false'; } catch(e){} };

    const popupCommentsArea = document.getElementById('popupComments');
    if (popupCommentsArea) popupCommentsArea.addEventListener('focusin', () => { const cur = document.querySelector('#feed video[data-is-playing="true"]'); if (cur) try { cur.pause(); cur.dataset.isPlaying='false'; } catch(e){} });

  })();

  function findPostBoxFromMedia(el){ return el.closest('.post-box'); }
  function onPostMediaClick(e){ const mediaEl = e.currentTarget; openPopupWithMedia(mediaEl); }

  // -------------------------
  // POPUP LOGIC (full-screen + swipe prev/next)
  // (kept unchanged)
  // -------------------------
  const popup = $('#postPopup');
  const popupMediaHolder = $('#popupMediaHolder');
  const popupCommentsList = $('#popupCommentsList');
  const popupCommentsArea = $('#popupComments');
  const popupReplyInput = $('#popupReplyInput');
  const popupReplyBtn = $('#popupReplyBtn');
  const popupCloseBtn = $('#popupCloseBtn');
  const popupPlayPauseBtn = $('#popupPlayPauseBtn');
  const popupPrevBtn = $('#popupPrevBtn');
  const popupNextBtn = $('#popupNextBtn');
  const commentHandle = $('#commentHandle');

  /***** popup action buttons and media container references *****/
  const popupLikeBtn = $('#popupLikeBtn');
  const popupCommentBtn = $('#popupCommentBtn');
  const popupShareBtn = $('#popupShareBtn');
  const popupMusicBtn = $('#popupMusicBtn'); // NEW
  const popupMedia = $('#popupMedia');
  const popupMediaWrap = $('#popupMediaWrap');
  const popupCommentsEl = $('#popupComments');
  const popupBg = $('#popupBg');
  const popupInner = $('#popupInner');
  const popupActions = document.querySelector('.popup-actions');

  let popupPlayingVideo = null;
  let popupSourcePostBox = null;
  let feedMediaSources = []; // ordered list of feed media srcs (images + videos)
  let currentPopupIndex = -1;

  // ---------- ACTION BAR VISIBILITY CONTROL ----------
  let actionsVisible = true;
  let _actionsTimer = null;
  let _actionsForceHidden = false;
  const ACTIONS_AUTO_SHOW_MS = 3500;

  function _clearActionsTimer(){
    if (_actionsTimer) { clearTimeout(_actionsTimer); _actionsTimer = null; }
  }

  function setPopupActionsVisible(visible, { forceHidden = false, autoShowAfterMs = null } = {}) {
    _clearActionsTimer();
    if (forceHidden) {
      _actionsForceHidden = true;
      actionsVisible = false;
      popupActions?.classList.add('actions-hidden');
      if (autoShowAfterMs) {
        _actionsTimer = setTimeout(() => {
          _actionsForceHidden = false;
          actionsVisible = true;
          popupActions?.classList.remove('actions-hidden');
          _actionsTimer = null;
        }, autoShowAfterMs);
      }
      return;
    }
    if (!visible) {
      actionsVisible = false;
      popupActions?.classList.add('actions-hidden');
      return;
    }
    if (_actionsForceHidden) {
      return;
    }
    actionsVisible = true;
    popupActions?.classList.remove('actions-hidden');
  }

  function hidePopupActionsWithAutoShow() {
    setPopupActionsVisible(false, { forceHidden: true, autoShowAfterMs: ACTIONS_AUTO_SHOW_MS });
  }

  function showPopupActionsImmediate(){
    setPopupActionsVisible(true, { forceHidden: false });
  }

  function togglePopupActionsByUser(){
    if (_actionsForceHidden) {
      _actionsForceHidden = false;
      showPopupActionsImmediate();
      _clearActionsTimer();
      return;
    }
    if (actionsVisible) {
      hidePopupActionsWithAutoShow();
    } else {
      showPopupActionsImmediate();
    }
  }

 function refreshFeedMediaSources(){
  const mediaEls = Array.from(document.querySelectorAll('#feed .post-video, #feed .post-img, #feed .cloud-video-poster, #feed video, #feed img'));
  feedMediaSources = mediaEls.map((el, idx) => {
    // priority: data-src (native), dataset.src, src (img), or data-src for cloud poster points to embed
    const s = el.dataset.src || el.getAttribute('data-src') || el.querySelector('source')?.src || el.src || '';
    const isCloud = el.classList && el.classList.contains('cloud-video-poster');
    const t = isCloud ? 'cloud-video' : (el.tagName.toLowerCase() === 'video' ? 'video' : 'image');
    return { src: s, feedIndex: parseInt(el.dataset.feedIndex || idx), poster: el.getAttribute('poster') || el.style.backgroundImage?.replace(/url\(["']?(.*?)["']?\)/,'$1') || '', postBox: el.closest('.feed-card'), type: t };
  });
}


  function showPopupIndex(idx){
    if (idx < 0 || idx >= feedMediaSources.length) return;
    currentPopupIndex = idx;
    if (popupPlayingVideo){
      try{ popupPlayingVideo.pause(); popupPlayingVideo.src=''; } catch(e){}
      popupPlayingVideo = null;
    }
    if (popupBg) { popupBg.style.display = 'none'; popupBg.style.backgroundImage = ''; }
    popupMediaHolder.innerHTML = '';
    const info = feedMediaSources[idx];
    if (!info || !info.src) return;
    const isImage = /\.(jpe?g|png|webp|jpeg)$/i.test(info.src);
    if (isImage) {
      const img = document.createElement('img');
      img.src = info.src;
      img.style.objectFit = 'cover';
      img.setAttribute('alt', info.src);
      popupMediaHolder.appendChild(img);
      popupPlayingVideo = null;
      popupPlayPauseBtn.style.display = 'none';
      img.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const c = $('#popupComments');
        if (c && c.classList.contains('open')) { closeComments(); return; }
        togglePopupActionsByUser();
      });
    } else {
  // If this feed item is a Cloudinary embed (iframe), create iframe; otherwise create native video
  const infoType = info.type || '';
  if (infoType === 'cloud-video' || /\.cloudinary\.com\/embed\/?/i.test(info.src) || info.src.includes('player.cloudinary.com/embed')) {
    // Cloudinary embed iframe
    const iframe = document.createElement('iframe');
    iframe.src = info.src;
    iframe.width = '100%';
    iframe.height = '100%';
    iframe.allow = 'autoplay; fullscreen; encrypted-media';
    iframe.frameBorder = '0';
    iframe.setAttribute('allowfullscreen', '');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = '0';
    iframe.style.background = '#000';
    iframe.style.objectFit = 'cover';
    // place iframe
    popupMediaHolder.appendChild(iframe);
    popupPlayingVideo = null; // cannot control iframe like a video element
    // hide play/pause since iframe is not a controllable <video>
    popupPlayPauseBtn.style.display = 'none';
  } else {
    // native video (existing logic, unchanged)
    const video = document.createElement('video');
    video.controls = true;
    video.playsInline = true;
    video.preload = 'auto';
    video.autoplay = true;
    video.loop = false;
    video.style.width = '100%';
    video.style.height = '100%';
    video.muted = true;
    video.style.maxWidth = '100%';
    video.style.maxHeight = '100%';
    video.style.objectFit = 'cover';
    const source = document.createElement('source');
    source.src = info.src;
    video.appendChild(source);
    if (info.poster) video.setAttribute('poster', info.poster);
    // existing listeners and logic...
    video.addEventListener('click', (ev) => {
      ev.stopPropagation();
      if (popupCommentsEl && popupCommentsEl.classList.contains("open")) {
        closeComments();
        return;
      }
      if (video.paused) {
        video.play().catch(()=>{});
        if (popupPlayPauseBtn) popupPlayPauseBtn.textContent = "‚è∏";
      } else {
        video.pause();
        if (popupPlayPauseBtn) popupPlayPauseBtn.textContent = "‚ñ∂";
      }
      togglePopupActionsByUser();
    });
    video.addEventListener('loadedmetadata', () => {
      try {
        const vidAR = video.videoWidth / (video.videoHeight || 1);
        const winAR = window.innerWidth / (window.innerHeight || 1);
        if (vidAR > winAR * 1.05) {
          video.style.objectFit = 'contain';
          const bgUrl = info.poster || info.src;
          if (bgUrl && popupBg) {
            popupBg.style.backgroundImage = `url("${bgUrl}")`;
            popupBg.style.display = 'block';
          }
        } else {
          video.style.objectFit = 'cover';
          if (popupBg) popupBg.style.display = 'none';
        }
      } catch(e){}
    });
    video.addEventListener('ended', () => {
      setTimeout(()=> navigatePopup(1), 260);
    });
    popupMediaHolder.appendChild(video);
    popupPlayingVideo = video;
    video.play().then(()=> {
      setTimeout(()=> { try{ video.muted = false; } catch(e){} }, 300);
    }).catch(()=>{});
    popupPlayPauseBtn.style.display = 'inline-block';
    popupPlayPauseBtn.textContent = '‚è∏';
  }
}


    popupCommentsList.innerHTML = '';
    try {
      const postCard = info.postBox;
      if (postCard){
        const feedComments = postCard.querySelectorAll('.comment');
        feedComments.forEach(c => {
          const username = c.querySelector('.comment-username')?.innerText || 'User';
          const text = c.querySelector('.comment-text')?.innerText || '';
          const meta = c.querySelector('.comment-meta')?.innerText || '';
          const initials = (username) ? (username.split(/[_\.\- ]+/)[0].slice(0,1).toUpperCase() + (username.split(/[_\.\- ]+/)[1]?.slice(0,1)?.toUpperCase()||'')) : 'U';
          const div = document.createElement('div');
          div.className = 'popup-comment';
          div.innerHTML = `<div class="avatar">${escapeHtml(initials)}</div>
                           <div class="body"><div style="font-weight:700">${escapeHtml(username)}</div><div style="margin-top:6px">${escapeHtml(text)}</div>
                           <div class="meta">${escapeHtml(meta)} <button class="like">‚ô°</button></div></div>`;
          popupCommentsList.appendChild(div);
        });
      } else {
        popupCommentsList.innerHTML = generateCommentsHTML(6);
      }
    } catch(e){
      popupCommentsList.innerHTML = generateCommentsHTML(6);
    }

    $all('.popup-comment .like').forEach(btn => { btn.onclick = popupCommentLikeHandler; });

    if (!_actionsForceHidden) showPopupActionsImmediate();
  }

  function openPopupWithMedia(mediaEl){
    if (window.__pauseAutoplay) window.__pauseAutoplay();
    assignFeedIndices();
    refreshFeedMediaSources();
    const feedIndex = parseInt(mediaEl.dataset.feedIndex || -1);
    let idx = feedMediaSources.findIndex(s => s.feedIndex === feedIndex);
    if (idx === -1) {
      const src = mediaEl.dataset.src || mediaEl.querySelector('source')?.src || mediaEl.src || '';
      idx = feedMediaSources.findIndex(s => s.src === src);
    }
    if (idx === -1) idx = 0;
    popupSourcePostBox = findPostBoxFromMedia(mediaEl);
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    popup.style.display = 'block';
    popup.setAttribute('aria-hidden','false');
    closeComments();
    _actionsForceHidden = false;
    _clearActionsTimer();
    showPopupActionsImmediate();
    showPopupIndex(idx);
    attachPopupHandlers();
  }

  function openComments(){
    if (!popup) return;
    const media = popupMedia;
    media.classList.add('comments-open');
    document.documentElement.style.setProperty('--popup-comments-height', '36vh');
    popupCommentsEl.classList.add('open');
    document.querySelector('.comment-handle')?.classList.add('visible');
    if (popupPlayingVideo && !popupPlayingVideo.paused) {
      try { popupPlayingVideo.pause(); popupPlayPauseBtn.textContent = '‚ñ∂'; } catch(e){}
    }
    setTimeout(()=> { try { popupReplyInput.focus(); } catch(e){} }, 260);
    _actionsForceHidden = false;
    showPopupActionsImmediate();
  }

  function closeComments(){
    if (!popup) return;
    popupMedia.classList.remove('comments-open');
    document.documentElement.style.setProperty('--popup-comments-height', '0vh');
    popupCommentsEl.classList.remove('open');
    document.querySelector('.comment-handle')?.classList.remove('visible');
    if (!_actionsForceHidden) showPopupActionsImmediate();
  }

  function attachPopupHandlers(){
    let startX = 0, startY = 0, isMoving = false;
    const threshold = 50;
    function onTouchStart(e){
      const t = e.touches ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : null);
      if (!t) return;
      startX = t.clientX;
      startY = t.clientY;
      isMoving = true;
    }
    function onTouchMove(e){
      if (!isMoving || !e.touches) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 6) e.preventDefault();
    }
    function onTouchEnd(e){
      if (!isMoving) return;
      isMoving = false;
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      const endX = t ? t.clientX : startX;
      const dx = endX - startX;
      if (dx > threshold) navigatePopup(-1);
      else if (dx < -threshold) navigatePopup(1);
    }

    function onOverlayClick(ev){
      const target = ev.target;
      if (target.closest && target.closest('.popup-media-wrap')) return;
      closePopup();
    }

    const mediaWrap = $('#popupMediaWrap') || $('#popupMedia');
    if (mediaWrap) {
      mediaWrap.removeEventListener('touchstart', onTouchStart);
      mediaWrap.removeEventListener('touchmove', onTouchMove);
      mediaWrap.removeEventListener('touchend', onTouchEnd);
      mediaWrap.addEventListener('touchstart', onTouchStart, {passive:false});
      mediaWrap.addEventListener('touchmove', onTouchMove, {passive:false});
      mediaWrap.addEventListener('touchend', onTouchEnd);
    }

    popup.removeEventListener('click', onOverlayClick);
    popup.addEventListener('click', onOverlayClick);

    popupPrevBtn.removeEventListener('click', onPrev);
    popupNextBtn.removeEventListener('click', onNext);
    popupPrevBtn.addEventListener('click', onPrev);
    popupNextBtn.addEventListener('click', onNext);

    popupPlayPauseBtn.removeEventListener('click', togglePopupPlayPause);
    popupPlayPauseBtn.addEventListener('click', togglePopupPlayPause);

    popupCloseBtn.removeEventListener('click', closePopup);
    popupCloseBtn.addEventListener('click', closePopup);

    popupCommentsArea.removeEventListener('click', pauseVideoOnCommentFocus);
    popupCommentsArea.addEventListener('click', pauseVideoOnCommentFocus);
    popupCommentsArea.removeEventListener('focusin', pauseVideoOnCommentFocus);
    popupCommentsArea.addEventListener('focusin', pauseVideoOnCommentFocus);

    popupReplyBtn.onclick = onPopupReply;
    popupReplyInput.onkeydown = e => { if(e.key === 'Enter') onPopupReply(); };

    $all('.popup-comment .like').forEach(btn => { btn.onclick = popupCommentLikeHandler; });

    document.removeEventListener('keydown', popupKeyHandler);
    document.addEventListener('keydown', popupKeyHandler);

    function onPrev(e){ e.stopPropagation(); navigatePopup(-1); }
    function onNext(e){ e.stopPropagation(); navigatePopup(1); }

    if (popupCommentBtn) {
      popupCommentBtn.removeEventListener('click', popupCommentBtnHandler);
      popupCommentBtn.addEventListener('click', popupCommentBtnHandler);
    }
    function popupCommentBtnHandler(e){
      e.stopPropagation();
      const c = $('#popupComments');
      if (!c) return;
      const isOpen = c.classList.toggle('open');
      if (isOpen) {
        openComments();
      } else {
        closeComments();
      }
    }

    if (popupLikeBtn) {
      popupLikeBtn.removeEventListener('click', popupLikeHandlerSafe);
      popupLikeBtn.addEventListener('click', popupLikeHandlerSafe);
      popupLikeBtn.removeEventListener('click', showLikeAnimation);
      popupLikeBtn.addEventListener('click', showLikeAnimation);
    }
    function popupLikeHandlerSafe(e){
      e.stopPropagation();
      if (!popupLikeBtn) return;
      if (popupLikeBtn.textContent.includes('‚ô°')) popupLikeBtn.innerHTML = '‚ô• Liked';
      else popupLikeBtn.innerHTML = '‚ô° Like';
    }

    if (popupShareBtn) {
      popupShareBtn.removeEventListener('click', popupShareHandler);
      popupShareBtn.addEventListener('click', popupShareHandler);
    }

    if (popupMusicBtn) {
      popupMusicBtn.removeEventListener('click', popupMusicHandler);
      popupMusicBtn.addEventListener('click', popupMusicHandler);
    }

    function popupMusicHandler(e){
      e.stopPropagation();
      if (!popupMusicBtn) return;

      const isActive = popupMusicBtn.classList.toggle('music-active');
      const info = feedMediaSources[currentPopupIndex] || {};
      let trackName = 'Unknown track';
      try {
        const src = info.src || '';
        const file = src.split('/').pop() || src;
        trackName = file.replace(/\.(webm|mp4|m4a|mp3|ogg)$/i,'').replace(/[_\-]/g,' ');
        if (!trackName) trackName = 'Unknown track';
      } catch(err){}
      showMusicToast(isActive ? `Playing: ${trackName}` : `Stopped: ${trackName}`);
    }

    function showMusicToast(text, timeout = 1600){
      let t = document.getElementById('musicToast');
      if (!t) {
        t = document.createElement('div');
        t.id = 'musicToast';
        document.body.appendChild(t);
      }
      t.textContent = text;
      t.classList.add('show');
      clearTimeout(t._hideTimer);
      t._hideTimer = setTimeout(()=> { t.classList.remove('show'); }, timeout);
    }

    function popupShareHandler(e){
      e.stopPropagation();
      try {
        if (navigator.share && feedMediaSources[currentPopupIndex]) {
          navigator.share({ title: document.title, url: feedMediaSources[currentPopupIndex].src }).catch(()=>{});
        } else {
          alert('Share: ' + (feedMediaSources[currentPopupIndex]?.src || window.location.href));
        }
      } catch(err){}
    }

    if (popupMedia) {
      popupMedia.removeEventListener('click', mediaAreaClickHandler);
      popupMedia.addEventListener('click', mediaAreaClickHandler);
    }
    function mediaAreaClickHandler(ev){
      const c = $('#popupComments');
      const clickedVideo = Boolean(ev.target && ev.target.tagName && ev.target.tagName.toLowerCase() === 'video');
      if (c && c.classList.contains('open')) {
        closeComments();
        ev.stopPropagation();
        ev.preventDefault();
        return;
      }
      if (clickedVideo) return;
      togglePopupActionsByUser();
    }

  }

  function popupKeyHandler(e){ if (e.key === 'Escape') closePopup(); }

  function navigatePopup(direction){
    const next = currentPopupIndex + direction;
    if (next < 0 || next >= feedMediaSources.length) return;
    showPopupIndex(next);
  }

  function pauseVideoOnCommentFocus(){
    if (popupPlayingVideo && !popupPlayingVideo.paused){
      popupPlayingVideo.pause();
      popupPlayPauseBtn.textContent = '‚ñ∂';
    }
  }

  function togglePopupPlayPause(e){
    e && e.stopPropagation();
    if (!popupPlayingVideo) return;
    if (popupPlayingVideo.paused){
      popupPlayingVideo.play().catch(()=>{});
      popupPlayPauseBtn.textContent = '‚è∏';
    } else {
      popupPlayingVideo.pause();
      popupPlayPauseBtn.textContent = '‚ñ∂';
    }
  }

  function popupCommentLikeHandler(e){
    e.stopPropagation();
    const btn = e.currentTarget;
    btn.textContent = (btn.textContent === '‚ô°') ? '‚ô•' : '‚ô°';
  }

  function onPopupReply(){
    const text = popupReplyInput.value.trim();
    if (!text) return;
    const name = localStorage.getItem('user_session') || 'You';
    const initials = getInitials(name);
    const div = document.createElement('div');
    div.className = 'popup-comment';
    div.innerHTML = `<div class="avatar" style="background:var(--avatar-bg);color:var(--avatar-fg)">${initials}</div>
                     <div class="body"><div style="font-weight:700">${escapeHtml(name)}</div><div style="margin-top:6px">${escapeHtml(text)}</div>
                     <div class="meta">just now <button class="like">‚ô°</button></div></div>`;
        popupCommentsList.prepend(div);
    const likeBtn = div.querySelector('.like'); if (likeBtn) likeBtn.onclick = popupCommentLikeHandler;

    try {
      setTimeout(() => {
        if (popupCommentsEl && typeof popupCommentsEl.scrollTop !== 'undefined') {
          popupCommentsEl.scrollTop = 0;
        } else if (popupCommentsList && typeof popupCommentsList.scrollTop !== 'undefined') {
          popupCommentsList.scrollTop = 0;
        }
      }, 40);
    } catch(e){}

    const info = feedMediaSources[currentPopupIndex];
    if (info && info.postBox){
      const feedCommentBox = info.postBox.querySelector('.comment-box');
      if (feedCommentBox){
        const feedDiv = document.createElement('div');
        feedDiv.className = 'comment';
        feedDiv.innerHTML = `<div class="comment-left"><div class="comment-user-pic">${initials}</div>
                             <div class="comment-body"><div class="comment-header-line"><span class="comment-username">${escapeHtml(name)}</span>
                             <button class="heart-small" title="Like">‚ô°</button></div><span class="comment-text">${escapeHtml(text)}</span>
                             <div class="comment-meta">just now</div></div></div>`;
        feedCommentBox.prepend(feedDiv);
        const newLikeBtn = feedDiv.querySelector('.heart-small');
        if (newLikeBtn) newLikeBtn.addEventListener('click', commentLikeHandler);
      }
    }

    popupReplyInput.value = '';
    pauseVideoOnCommentFocus();
  }

  function closePopup(){
  // stop any native popup video (existing)
  if (popupPlayingVideo){
    try { popupPlayingVideo.pause(); popupPlayingVideo.src = ''; } catch(e){}
    popupPlayingVideo = null;
  }

  // --- STOP & REMOVE any iframe (Cloudinary / cross-origin player) ---
  try {
    const iframe = popupMediaHolder.querySelector('iframe');
    if (iframe) {
      // best: set to blank then remove
      try { iframe.src = 'about:blank'; } catch(e){}
      iframe.remove();
    }
  } catch(e){ /* ignore */ }

  if (popupBg) { popupBg.style.display = 'none'; popupBg.style.backgroundImage = ''; }
  closeComments();
  popup.style.display = 'none';
  popup.setAttribute('aria-hidden','true');
  document.removeEventListener('keydown', popupKeyHandler);
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
  _actionsForceHidden = false;
  _clearActionsTimer();
  actionsVisible = true;
  setTimeout(()=> window.__setupSingleVideoAutoplay?.(), 200);
}


  // -------------------------
  // Lazy loading with IntersectionObserver
  // -------------------------
  (function lazyObserve(){
    const io = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const el = entry.target;
        io.unobserve(el);
        if (el.tagName === 'IMG'){
          const ds = el.dataset.src;
          if (ds){ el.src = ds; el.removeAttribute('data-src'); }
          el.classList.remove('skeleton');
        } else if (el.tagName === 'VIDEO'){
          const ds = el.dataset.src;
          if (ds){
            if (!el.querySelector('source')){
              const src = document.createElement('source');
              src.src = ds;
              el.appendChild(src);
            } else {
              el.querySelector('source').src = ds;
            }
            el.preload = 'auto';
            el.muted = true;
            try { el.load(); } catch(e){}
          }
          el.classList.remove('skeleton');
        }
      });
    }, { root:null, rootMargin:'300px 0px', threshold:0.01 });

    window.__observeMedia = () => {
      $all('img[data-src], video[data-src]').forEach(el => {
        el.classList.add('skeleton');
        io.observe(el);
      });
    };
  })();

  // --------------------------------------------------------------------------------
  // CONTENT SWAP LOGIC - persists header + footer and swaps only the main content
  // --------------------------------------------------------------------------------

  // store original home container HTML so we can restore exactly
  const originalHomeHTML = document.getElementById('mainContentWrapper').innerHTML;

  // -------------------------
  // NEW: Safety page markup replaced with requested layout.
  // Only this function was changed from your original file.
  // -------------------------
  function renderSafetyHTML(){
    return `
      <div class="main-feed-container" id="safetyMain" style="padding-bottom:120px;">
         <div id="mainContentWrapper" style="width:100%;max-width:720px;">
        <div class="top-left-header" aria-hidden="false" id="appHeader">
      <div style="display:flex;flex-direction:column;min-width:0;">
        <div class="brand">SHAKTI-IND</div>
      </div>
      <div class="top-search" role="search" aria-label="Search content, users, IDs">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#999" stroke-width="2"/></svg>
        <input id="globalSearch" placeholder="Search users, content, ID..." aria-label="Search users or content">
      </div>
    </div>
        <div class="feed-card" style="border-radius:12px;padding:14px; position:relative;">
          <div style="display:flex;align-items:center;gap:8px" class="small-live">
            <div class="safety-live-small">Live</div>
            <div class="safety-live-line" id="liveTicker">Alert acknowledged ‚Äî you're protected.</div>
          </div>
        </div>

        <!-- Map card: map occupies approx half/large portion -->
        <div class="feed-card" style="padding:12px;border-radius:12px; position:relative;">
          <div style="font-weight:700;color:#111;padding:8px;border-radius:8px">
            <div style="font-weight:800;font-size:18px;text-align:center;color:var(--headline-blue)">Nearby Live Codes</div>
            <div style="text-align:center;opacity:0.85;margin-top:6px;font-size:13px">Showing active codes in your region</div>

            <!-- Map (clean, no dark gradient) -->
            <div id="safetyMap" style="margin-top:12px;"></div>

            <div style="margin-top:10px; display:flex; justify-content:center;">
              <span style="display:inline-flex;align-items:center;gap:8px;background:#fff;padding:6px 10px;border-radius:10px;color:#111;font-weight:700">
                <span style="width:10px;height:10px;border-radius:10px;background:#ff4d4d;display:inline-block"></span> Active
              </span>
            </div>
          </div>

          <!-- floating notification bubble (top-right of this card) -->
          <div id="safetyNotifBubble" class="safety-notification-bubble" title="View safety notifications" style="display:none;">
            <span class="dot"></span><span id="safetyNotifCount">0</span>
          </div>

          <!-- card below map that covers till navbar -->
          <div class="safety-card" style="margin-top:12px;">
            <div style="font-weight:800;font-size:18px;color:var(--headline-blue)">Quick categories</div>
            <div style="color:var(--muted);margin-top:8px;font-size:13px">Tap a category to open details</div>

            <div class="cat-grid" style="margin-top:12px">
              <div class="cat-box" id="catMen"><strong>Men / Women</strong><p>Personal safety & reporting</p></div>
              <div class="cat-box" id="catAnimals"><strong>Animal / Nature</strong><p>Wildlife & environmental alerts</p></div>
              <div class="cat-box" id="catHuman"><strong>Humanity / Emergency</strong><p>SOS & community help</p></div>
              <div class="cat-box" id="catShakti"><strong>Quick access to Shakti Code</strong><p>Activate emergency code</p></div>
            </div>

            <!-- detail area that opens inside the same card -->
            <div id="catDetail" style="display:none;margin-top:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div id="catDetailTitle" style="font-weight:800">Title</div>
                <button id="catDetailClose" class="back-x">‚úï</button>
              </div>
              <div id="catDetailBody" class="cat-detail"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // NEW: openShaktiPopupURL - loads given URL into the big Shakti iframe popup
  function openShaktiPopupURL(pageUrl) {
    try {
      const popup = document.getElementById("shaktiPopup");
      const frame = document.getElementById("shaktiFrame");
      if (!popup || !frame) {
        alert('Shakti console not available');
        return;
      }

      // pause feed autoplay if running
      if (window.__pauseAutoplay) window.__pauseAutoplay();

      // lock scroll
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";

      // set src and show
      frame.src = pageUrl;
      popup.style.display = "flex";
      popup.setAttribute('aria-hidden','false');
    } catch (err) {
      console.warn('openShaktiPopupURL error', err);
    }
  }

  // close and clear iframe to stop any playback
  function closeShaktiPopup() {
    const popup = document.getElementById('shaktiPopup');
    const frame = document.getElementById('shaktiFrame');
    if (!popup || !frame) return;
    frame.src = '';
    popup.style.display = 'none';
    popup.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  // -------------------------
  // NEW: functions to initialize safety page (map + categories + notifications)
  // Called right after we inject safety HTML in swapMainContent
  // -------------------------
  async function initSafetyPage(){
    // load external leaflet if needed, then init map and wire cats
    await ensureLeafletLoaded();
    initSafetyMap();
    wireSafetyCategories();
    initSafetyNotifications();
    initLiveTicker(); // start live messages ticker
  }

  function ensureLeafletLoaded(){
    return new Promise((resolve, reject) => {
      const CSS = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      const JS = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      if (window.L && window.L.map) return resolve();
      if (!document.querySelector(`link[href="${CSS}"]`)){
        const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = CSS; document.head.appendChild(l);
      }
      if (!document.querySelector(`script[src="${JS}"]`)){
        const s = document.createElement('script'); s.src = JS;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed loading Leaflet'));
        document.head.appendChild(s);
      } else {
        let tries = 0;
        const wait = setInterval(()=> {
          if (window.L && window.L.map) { clearInterval(wait); resolve(); }
          tries++;
          if (tries > 60) { clearInterval(wait); reject(new Error('Leaflet did not initialize')); }
        }, 50);
      }
    });
  }

  // Demo live codes - replace these with your real service/API later
  const DEMO_CODES = [
    { id: 101, lat: 12.9716, lng: 77.5946, type: 'men', label: '101 ‚Äî Personal safety' },
    { id: 107, lat: 12.9667, lng: 77.6000, type: 'human', label: '107 ‚Äî Emergency' },
    { id: 112, lat: 12.9550, lng: 77.5900, type: 'animal', label: '112 ‚Äî Animal' },
    { id: 120, lat: 12.9800, lng: 77.6100, type: 'human', label: '120 ‚Äî Help requested' }
  ];

  // Demo notifications list for safety (replace with real API)
  const DEMO_NOTIFICATIONS = [
    { id: 'n1', text: 'SOS triggered at Richmond Town ‚Äî code 107', time: '2m ago' },
    { id: 'n2', text: 'Animal sighting reported near Lalbagh ‚Äî code 112', time: '12m ago' },
    { id: 'n3', text: 'Shakti Code 101 acknowledged by police', time: '30m ago' },
    { id: 'n4', text: 'Volunteer requested near Wilson Garden', time: '1h ago' }
  ];

  // Live messages demo array (from your input)
  const demoMessages = [
    "Shakti helped me ‚Äî a stranger intervened and I reached home safely.",
    "SOS triggered ‚Äî community arrived in under 7 minutes.",
    "Evidence kit made my complaint strong and undeniable.",
    "Route alert saved me from entering an unsafe zone.",
    "Voice wakeword detected instantly ‚Äî support activated.",
    "Officer rerouted and reached faster due to Shakti AI.",
    "Live audio captured everything ‚Äî justice became easier.",
    "A silent SOS saved me when I couldn‚Äôt speak.",
    "Trusted contacts received my alert even on low signal.",
    "One alert today prevented a major incident.",
    "‡§∂‡§ï‡•ç‡§§‡§ø ‡§®‡•á ‡§µ‡§ï‡•ç‡§§ ‡§™‡§∞ ‡§Æ‡§¶‡§¶ ‡§≠‡•á‡§ú‡•Ä ‚Äî ‡§Æ‡•à‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•Ç‡§Å‡•§",
    "‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡•á SOS ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§π‡•Å‡§Ü ‚Äî ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§™‡§π‡•Å‡§Å‡§ö‡•Ä‡•§",
    "‡Æö‡Æï‡Øç‡Æ§‡Æø ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡ÆØ‡Æ§‡ØÅ ‚Äî ‡Æ®‡Ææ‡Æ©‡Øç ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Øá‡Æ©‡Øç.",
    "‡∞∂‡∞ï‡±ç‡∞§‡∞ø ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç ‡∞™‡∞Ç‡∞™‡∞ø‡∞Ç‡∞¶‡∞ø ‚Äî ‡∞®‡±á‡∞®‡±Å ‡∞∏‡±á‡∞´‡±ç‚Äå‡∞ó‡∞æ ‡∞â‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å.",
    "‡≤∂‡≤ï‡≥ç‡≤§‡≤ø ‡≤Ö‡≤≤‡≤∞‡≥ç‡≤ü‡≥ç ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤ø‡≤¶ ‡≤ï‡≤æ‡≤∞‡≤£ ‡≤®‡≤æ‡≤®‡≥Å ‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤ø‡≤§‡≤®‡≤æ‡≤¶‡≥Ü.",
    "‡¥∂‡¥ï‡µç‡¥§‡¥ø ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥§‡µÜ ‡¥∏‡¥π‡¥æ‡¥Ø‡¥Ç ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ö‡µç‡¥ö‡µÅ.",
    "Shakti on ‚Äî fear gone.",
    "Aap akela nahi ho ‚Äî Shakti with you.",
    "You are not alone ‚Äî ever.",
    "One alert = one life saved."
  ];

  // Keep a global map ref so re-opening safety doesn't double-initialize
  window.__safetyMap = window.__safetyMap || null;
  function initSafetyMap(){
    try {
      const el = document.getElementById('safetyMap');
      if (!el) return;
      if (window.__safetyMap) {
        try { window.__safetyMap.remove(); } catch(e){}
        window.__safetyMap = null;
      }

      const center = DEMO_CODES.length ? [DEMO_CODES[0].lat, DEMO_CODES[0].lng] : [12.9716,77.5946];
      const map = L.map(el, { center, zoom: 13, zoomControl: true, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      DEMO_CODES.forEach(c => {
        const html = `<div style="background:#ff4d4d;color:#fff;padding:6px 8px;border-radius:20px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,0.12)">${c.id}</div>`;
        const icon = L.divIcon({ className: '', html, iconSize:[44,24], iconAnchor:[22,12] });
        const m = L.marker([c.lat, c.lng], { icon }).addTo(map);
        m.bindPopup(`<strong>${escapeHtml(c.label)}</strong><div style="margin-top:8px"><button onclick="(function(){ openShaktiPopupURL('shakti_code_WMS-${c.id}.html'); })()" style="padding:6px 8px;border-radius:8px;border:none;background:#138808;color:#fff;cursor:pointer">Open</button></div>`);
      });

      // simple locate control
      const locate = L.control({position:'topright'});
      locate.onAdd = function(){
        const elBtn = L.DomUtil.create('button','locate-btn');
        elBtn.innerHTML = 'üìç';
        elBtn.style.background = '#fff';
        elBtn.style.padding = '8px';
        elBtn.style.border = 'none';
        elBtn.style.borderRadius = '8px';
        elBtn.style.cursor = 'pointer';
        elBtn.title = 'Center';
        elBtn.onclick = () => map.setView(center, 13);
        return elBtn;
      };
      locate.addTo(map);

      window.__safetyMap = map;

      // ensure the floating notif is positioned relative to the map container
      positionSafetyNotif();
      window.addEventListener('resize', positionSafetyNotif);

    } catch (err){
      console.warn('initSafetyMap error', err);
    }
  }

  // position the floating notification bubble inside the map card
  function positionSafetyNotif(){
    try {
      const card = document.querySelector('.feed-card');
      const bubble = document.getElementById('safetyNotifBubble');
      const mapEl = document.getElementById('safetyMap');
      if (!bubble || !mapEl) return;
      // show bubble
      bubble.style.display = 'flex';
    } catch(e){}
  }

  function wireSafetyCategories(){
    const men = document.getElementById('catMen');
    const animals = document.getElementById('catAnimals');
    const human = document.getElementById('catHuman');
    const shakti = document.getElementById('catShakti');
    const detail = document.getElementById('catDetail');
    const titleEl = document.getElementById('catDetailTitle');
    const bodyEl = document.getElementById('catDetailBody');
    const closeBtn = document.getElementById('catDetailClose');

    function openDetail(t, html){
      titleEl.innerText = t;
      bodyEl.innerHTML = html;
      detail.style.display = 'block';
      try { detail.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
    }
    function closeDetail(){ detail.style.display = 'none'; }

    if (men) men.onclick = () => openDetail('Men / Women', `<p style="color:#777">Personal safety steps:</p>
      <div class="feed-card" style="padding:14px;border-radius:12px;">

  <div style="font-weight:700;font-size:18px;margin-bottom:12px;">Codes available</div>

  <!-- WMS-101 -->
  <div class="safety-code-box">
    <div class="title">WMS-101 ‚Äî WorkSpace Safety Code</div>
    <div class="desc">AI-assisted reporting, guided evidence collection and legal help.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_WMS-101.html')">Activate</button>
  </div>

  <!-- WMS-0101 -->
  <div class="safety-code-box">
    <div class="title">WMS-0101 ‚Äî Shakti-Code</div>
    <div class="desc">Send live location and audio to trusted contacts & authorities.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_WMS-0101.html')">Activate</button>
  </div>

  <!-- WMS-RAG -->
  <div class="safety-code-box">
    <div class="title">WMS-RAG ‚Äî Anti Ragging & Anti Harassment</div>
    <div class="desc">To eradicate harassment and ragging from roots.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_WMS-RAG.html')">Activate</button>
  </div>

  <!-- WMS-150 -->
  <div class="safety-code-box">
    <div class="title">WMS-150 ‚Äî Travel Safety Protocol</div>
    <div class="desc">Route monitoring, unsafe-area alerts and companion-tracking.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_WMS-150.html')">Activate</button>
  </div>

</div>`);

      if (men) animals.onclick = () => openDetail('Animal / Nature', `<p style="color:#777">Animal and surroundig safety codes</p>
      <div class="feed-card" style="padding:14px;border-radius:12px;">

  <div style="font-weight:700;font-size:18px;margin-bottom:12px;">Codes available</div>

  <!-- ANS-201 -->
  <div class="safety-code-box">
    <div class="title">ANS-201 ‚Äî Street Animal Protection</div>
    <div class="desc">Report injured or sick street animals, request animal rescue.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_ANS-201.html')">Activate</button>
  </div>

  <!-- ANS-240 -->
  <div class="safety-code-box">
    <div class="title">ANS-240 ‚Äî Forest Fire Alert</div>
    <div class="desc">Community-reported fire alerts combined with official data.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('Shakti_code_ANS-240.html')">Activate</button>
  </div>

  <!-- ANS 260 -->
  <div class="safety-code-box">
    <div class="title">ANS-260 ‚Äî Waterbody Pollution Report</div>
    <div class="desc">Report pollution events with photos and location metadata.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_ANS-260.html')">Activate</button>
  </div>

  

</div>`);


   if (men) human.onclick = () => openDetail('Humanity & Emergency Management', `<p style="color:#777">Codes for daily life</p>
      <div class="feed-card" style="padding:14px;border-radius:12px;">

  <div style="font-weight:700;font-size:18px;margin-bottom:12px;">Codes available</div>

  <!-- Hes 301 -->
  <div class="safety-code-box">
    <div class="title">HES-301 ‚Äî Medical Emergency Response</div>
    <div class="desc">Quick-request for nearest ambulance & first-aid steps.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_HES-301.html')">Activate</button>
  </div>

  <!-- ANS-240 -->
  <div class="safety-code-box">
    <div class="title">HES-320 ‚Äî Disaster Management</div>
    <div class="desc">Report infrastructure damage, request rescue and shelter info.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_HES-320.html')">Activate</button>
  </div>

  <!-- ANS 260 -->
  <div class="safety-code-box">
    <div class="title">HES-376 ‚Äî Ambulance Route Management</div>
    <div class="desc">Optimize ambulance routing, ETA tracking and priority dispatching.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_HES-376.html')">Activate</button>
  </div>

  <div class="safety-code-box">
    <div class="title">HES-350 ‚Äî Lost-Person Reporting</div>
    <div class="desc">Register lost-person data and broadcast on local networks.</div>
    <button class="activateBtn"
      onclick="openShaktiPopupURL('shakti_code_HES-350.html')">Activate</button>
  </div>

  

</div>`);

    if (shakti) shakti.onclick = () => { openShaktiPopupURL('shakti_code_WMS-0101.html'); };

    if (closeBtn) closeBtn.onclick = closeDetail;
  }

  // -------------------------
  // Safety notifications UX: bubble + modal
  // -------------------------
  function initSafetyNotifications(){
    const bubble = document.getElementById('safetyNotifBubble');
    if (!bubble) return;
    const countEl = document.getElementById('safetyNotifCount');

    // initialize with demo notifications
    const notifs = DEMO_NOTIFICATIONS.slice(); // copy
    countEl.innerText = notifs.length;

    // clicking the bubble opens the modal
    bubble.onclick = () => openSafetyNotifModal(notifs);

    // expose for later update (demo)
    window.__updateSafetyNotifs = (arr) => {
      const n = Array.isArray(arr) ? arr : [];
      countEl.innerText = n.length;
      bubble.style.display = n.length ? 'flex' : 'none';
    };

    // show if there are notifs
    bubble.style.display = notifs.length ? 'flex' : 'none';
  }

  function openSafetyNotifModal(notifs = []){
    // create modal element if not already present
    let existing = document.getElementById('safetyNotifModal');
    if (existing) { existing.remove(); } // recreate each time for simplicity
    const modal = document.createElement('div');
    modal.id = 'safetyNotifModal';
    modal.className = 'safety-notif-modal';
    modal.innerHTML = `
      <button class="safety-notif-close" aria-label="Close">‚úï</button>
      <h3>Safety notifications</h3>
      <div class="safety-notif-list">
        ${notifs.map(n => `<div class="safety-notif-item"><strong>${escapeHtml(n.text)}</strong><div style="color:var(--muted);margin-top:6px">${escapeHtml(n.time)}</div></div>`).join('')}
      </div>
    `;
    // clicking close removes modal
    modal.querySelector('.safety-notif-close').onclick = () => modal.remove();
    // clicking outside modal should also close it; we add an overlay behavior
    const overlay = document.createElement('div');
    overlay.id = 'safetyNotifOverlay';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.zIndex = 4999;
    overlay.style.background = 'rgba(0,0,0,0.26)';
    overlay.onclick = () => { modal.remove(); overlay.remove(); };
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
  }

  // -------------------------
  // Live ticker for messages (updates every 2 seconds)
  // -------------------------
  let _liveTickerTimer = null;
  function initLiveTicker(){
    const el = document.getElementById('liveTicker');
    if (!el) return;
    let i = 0;
    function showNext(){
      el.innerText = demoMessages[i % demoMessages.length];
      i++;
    }
    showNext();
    _liveTickerTimer = setInterval(showNext, 2000);
  }

  // -------------------------
  // swap function: page = 'home' | 'safety' | 'plus' | ...
  // -------------------------
  async function swapMainContent(page){
    const wrapper = document.getElementById('mainContentWrapper');
    if (!wrapper) return;
    if (page === 'safety'){
      wrapper.innerHTML = renderSafetyHTML();

      // safety buttons (if still present in markup)
      document.getElementById('sosBtn')?.addEventListener('click', () => {
        if (confirm('Trigger SOS? (demo)')) alert('SOS simulated ‚Äî notify contacts');
      });
      document.getElementById('callPolice')?.addEventListener('click', () => alert('Calling police (demo)'));
      document.getElementById('shareLoc')?.addEventListener('click', () => alert('Share location (demo)'));

      // rebuild story strip to focus on safety
      rebuildStoryStrip(['shaktisafety']);
      window.__pauseAutoplay?.();

      // initialize map, categories and notifications for safety page
      try { await initSafetyPage(); } catch(e){ console.warn('initSafetyPage failed', e); }

      return;
    }
    // ---------------- CHATS PAGE ----------------
if (page === 'plus') {
  const wrapper = document.getElementById('mainContentWrapper');
  wrapper.innerHTML = `
    <div style="width:100%;height:100vh;display:flex;align-items:center;justify-content:center;">
      <iframe 
        src="https://shaktichatind.vercel.app/" 
        style="width:100%;height:100%;border:none;border-radius:0;"
        allow="camera; microphone; autoplay; encrypted-media"
      ></iframe>
    </div>
  `;

  // Pause feed autoplay if active
  window.__pauseAutoplay?.();

  return;
}


    // default: restore home feed HTML and reinitialize feed
    wrapper.innerHTML = originalHomeHTML;
    setTimeout(async () => {
      await generateFeed(null);
      assignFeedIndices();
      attachFeedInteractions();
      window.__observeMedia?.();
      window.__setupSingleVideoAutoplay?.();
    }, 30);
  }

  // simplified setActiveNav that swaps content
  function setActiveNavAndSwap(elId){
    $all('.nav-item').forEach(n => n.classList.remove('active'));
    const el = document.getElementById(elId);
    if (el) el.classList.add('active');
    const page = el?.dataset?.page || 'home';
    swapMainContent(page);
  }

  // bottom nav wiring (use swap)
  document.getElementById('navHome').addEventListener('click', ()=> setActiveNavAndSwap('navHome'));
  document.getElementById('navSafety').addEventListener('click', ()=> setActiveNavAndSwap('navSafety'));
  document.getElementById('navPlus').addEventListener('click', ()=> setActiveNavAndSwap('navPlus'));
  document.getElementById('navCommunity').addEventListener('click', ()=> setActiveNavAndSwap('navCommunity'));
  document.getElementById('navProfile').addEventListener('click', ()=> setActiveNavAndSwap('navProfile'));

  // wire the shakti popup close button
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'shaktiPopupClose') closeShaktiPopup();
  });

  // -------------------------
  // Init on load: show ALL (all folders in /pics)
  // -------------------------
 window.addEventListener('load', async () => {
  document.documentElement.style.setProperty('--popup-comments-height', '0vh');

  if (window.startLoadingBar) window.startLoadingBar();

  await generateFeed(null);        // null => all folders

  setTimeout(() => { assignFeedIndices(); window.__observeMedia?.(); window.__setupSingleVideoAutoplay?.();
    if (window.finishLoadingBar) window.finishLoadingBar();
  }, 250);
});

  // small util
  function escapeHtml(text){
    return String(text || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]));
  }

</script>

</body>
</html>